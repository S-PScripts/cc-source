!function(e,t){"function"==typeof define&&define.amd?define(["comms","utf8","modules/window","modules/altdebug"],t):"object"==typeof exports?module.exports=t(require("comms"),require("utf8"),e,require("modules/altdebug")):(e.NSLibrary.Comms=NSLibrary.Comms||{},e.NSLibrary.Comms.Websocket=t(NSLibrary.Comms,NSLibrary.UTF8,e,db))}(this,function(t,i,e,s){const{localStorage:r,btoa:a}=e,n=["CONNECTING","OPEN","CLOSING","CLOSED"];class o extends t{constructor(e,t){super(e),l.mechanism=e,(l.instance=this).websocket=t}OPEN(){s.altdebug("76 comms.websocket- OPEN");var{macAddress:e,gatewayKey:t}=r,i=null==r.cloudState?"1":r.cloudState;return this._sendBase64Ascii(o.serialize({CMD:"OPEN",CLIENT_VERSION:"1.5",PROTOCOL_VER:"1.2",MAXPACKET:16200,SITE:r.site,SITEDEPT:r.department,CLIENT_NAME:E(r.serialNumber),CLIENT_ADDR:E(r.ipaddress),HOSTNAME:E(o.clientName()),MACADDRESS:E(o.prefix(e)),GSK:E(o.prefix(t)),APPTYPE:4096,EMAIL:E(r.fullemail),CHANNEL:E(r.roomspec),CONFIG_AGE:0,CONFIG_TIME:E(r.utctime),WEBCONFIG_TIME:E(r.webconfigtime),CLOUDSTATE:E(i),USERNAME:r.userName.split("@")[0],LOCATION:""!=r.location?r.location:"",USERGROUPS:"!",SAFEGUARDING:"1"==r.isPhrasematchEnabledFromEsafetyConfig?1:0,ANNOUNCE:1,SGCONFIG_TIME:r.lastSconfigTime,USEROU:null!=r.googleOrganisationalUnit?r.googleOrganisationalUnit:""}))}HEARTBEAT(){return this._sendBase64Ascii(o.serialize({CMD:"HEARTBEAT",APPTYPE:4096,REQUESTING_HELP:0}))}POLL(e){return this._sendBase64Ascii(o.serialize({CMD:"POLL",ACK:1,TS:E(e)}))}STATUS(e,t){s.altdebug("134 comms.websocket- STATUS"),s.altdebug("135 comms.websocket- room "+e),s.altdebug("136 STATUS - roomspec: "+e);var i=null==r.cloudState?"1":r.cloudState,a=""!=r.alternateEmailDomain&&null!=r.alternateEmailDomain&&"undefined"!=r.alternateEmailDomain?r.fullemail.split("@")[0]+"@"+r.alternateEmailDomain:""!=r.altemaildomain&&null!=r.altemaildomain&&"undefined"!=r.altemaildomain?r.fullemail.split("@")[0]+"@"+r.altemaildomain:r.fullemail,a=o.serialize({CMD:"STATUS",APPTYPE:4096,REQUESTING_HELP:t,USERNAME:E(o.clientName()),CHANNEL:E(o.prefix(e)),CLOUDSTATE:E(i),EMAIL:E(a),ANNOUNCE:1,SAFEGUARDING:"1"==r.isPhrasematchEnabledFromEsafetyConfig?1:0,USEROU:null!=r.googleOrganisationalUnit?r.googleOrganisationalUnit:""});return this._sendAsArrayBuffer(a)}STATUS_CLASSCODE(e){var t=null==r.cloudState?"1":r.cloudState,t=o.serialize({CMD:"STATUS",APPTYPE:4096,REQUESTING_HELP:0,USERNAME:E(o.clientName()),CHANNEL:E(o.prefix(e)),CLOUDSTATE:E(t),ANNOUNCE:1});return this._sendAsArrayBuffer(t)}HANGUP(e){return s.altdebug("167 comms.websocket- HANGUP"),this._sendBase64Ascii(o.serialize({CMD:"HANGUP",CONNECTION_ID:E(e)}))}CLOUD_STATUS(e){return this._sendBase64Ascii(o.serialize({CMD:"STATUS",APPTYPE:4096,REQUESTING_HELP:0,CLOUDSTATE:E(e),USERNAME:E(o.clientName()),CHANNEL:E(o.prefix(r.roomspec))}))}CONNECT_REPLY(e){return s.altdebug("195 comms.websocket- CONNECT_REPLY"),this._sendBase64Ascii(o.serialize({CMD:"CONNECT_REPLY",CONNECTION_ID:E(e),CLIENT_NAME:E(r.serialNumber),RESULT:0}))}BROADCASTDATA(e,t){if("undefined"!=r.roomspec&&""!=r.roomspec)return this._sendBase64Ascii(o.serialize({CMD:"BROADCASTDATA",FLAGS:0,AT:2560,FROM:"NCS/>"+E(r.ipaddress),CHANNEL:E(o.prefix(r.roomspec)),LEN:E(t.length),DATA:E(function(e){for(var t=[],i=0,a=0;a<e.length;++a)switch(e.charCodeAt(a)+42){case 0:case 9:case 10:case 13:case 256:case"=":case".":t[i++]="=",t[i++]=String.fromCharCode((e.charCodeAt(a)+64+42)%256);break;default:t[i++]=String.fromCharCode((e.charCodeAt(a)+42)%256)}return t.join("")}(t))}))}CLOSE(){return s.altdebug("222 comms.websocket- CLOSE"),this._sendBase64Ascii(o.serialize({cmd:"CLOSE"}))}static prefix(e){return i.PrefixEncode(e)}static clientName(){return this.prefix(r.clientName)}static serialize(t){let e=Object.keys(t).map(e=>`${e.toUpperCase()}=${t[e]}`);return e.push(""),e.join("\n")}static convertBinaryToString(e,t){let i="";for(var a=0;a<t;++a)i+=String.fromCharCode(e[a]);return i}_sendBase64Ascii(e){if(this._isReadyState(1)){e=a(e);return this.websocket.send(e),e}}_sendAsArrayBuffer(e){if(this._isReadyState(1)){e=t.str2ab(e);return this.websocket.send(e),e}}_isReadyState(e){var t=this.websocket["readyState"],i=t===e,e=`Socket is (${n[t]}) not (${n[e]})`;return i||console.warn(e),i}}var l={instance:void 0,mechanism:void 0,Commands:o,send:function(e){1===l.instance.websocket.readyState&&l.instance.websocket.send(e)}};function E(e){return null==typeof e?"undefined":e}return l});