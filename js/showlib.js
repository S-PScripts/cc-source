!function(t){"function"==typeof define&&define.amd?define(["student","modules/document","modules/debug"],t):"object"==typeof exports&&(module.exports=t(require("student"),require("modules/document"),require("modules/debug")))}(function(r,a){function i(e){return function(){var t=chrome.runtime.lastError;t&&t.message&&a(e+" - "+t.message)}}class o{constructor(){this.tempShowCanvas=document.createElement("canvas"),this.tempShowContext=this.tempShowCanvas.getContext("2d"),this.backBufferCanvas=document.createElement("canvas"),this.backBufferContext=this.backBufferCanvas.getContext("2d"),this.displayCanvas=void 0,this.displayContext=void 0,this.palette=[],this.isShowing=0,this.scaleToFit=1,this.isAnnotating=0,this.annotateCanvas=document.createElement("canvas"),this.annotateContext=this.annotateCanvas.getContext("2d"),this.isUpsideDown=!1,this.lastTab=void 0,this.isFullScreen=1,this.view={tab:void 0,window:void 0},this.showInterval=void 0,this.xOffset=0,this.yOffset=0,this.fragments=[],this.showHold=null}syncCanvas(t){t.width=this.Width||this.backBufferCanvas.width,t.height=this.Height||this.backBufferCanvas.height,this.backBufferCanvas&&t.getContext("2d").drawImage(this.backBufferCanvas,0,0),this.displayCanvas&&(this.backBufferContext.drawImage(this.displayCanvas,0,0),t.getContext("2d").drawImage(this.backBufferCanvas,0,0)),t.style.webkitTransform=t.style.webkitTransform+";translate3d(0,0,0)",this.displayCanvas=t,this.displayContext=t.getContext("2d"),this.Scale()}closeTab(t){t||(t=this.view.tab,this.view.tab=void 0),chrome.runtime.sendMessage({removeTab:!0,tabID:t,errorMessage:i("Error while loading show tab: "+t)})}closeWindow(t){t||(window.clearInterval(this.showInterval),t=this.view.window,this.view.window=void 0),chrome.runtime.sendMessage({removeWindow:!0,windowId:t})}endShow(){1===this.isShowing&&(r.powerMode="system",this.showHold=window.setTimeout(function(){chrome.runtime.sendMessage({requestKeepAwake:!0,powerMode:r.powerMode})},3e5),void 0!==this.view.tab&&closeTab(),void 0!==this.view.window&&closeWindow(),this.isShowing=0,this.lastTab&&chrome.runtime.sendMessage({tabsUpdate:!0,tabID:this.lastTab,tabData:{active:!0}}),this.backBufferCanvas=document.createElement("canvas"),this.backBufferContext=this.backBufferCanvas.getContext("2d"))}decodeBMP256(t){for(var e,a=this.tempShowContext.createImageData(this.tempShowCanvas.width,this.tempShowCanvas.height),i=0,s=t.length,h=0;h<s;h++)e=t.charCodeAt(h),a.data[i]=this.palette[e][0],a.data[i+1]=this.palette[e][1],a.data[i+2]=this.palette[e][2],a.data[i+3]=255,i+=4;return a}decodeBMP(t,e){e=e||0;var a,i,s=this.tempShowCanvas,h=this.tempShowContext.createImageData(s.width,s.height),n=0,o=t.length;if(e)for(var r=4*(s.width*s.height-s.width),n=r,d=0;d<o;d+=2)a=t[d],i=t[d+1],h.data[n]=i<<1&248,h.data[n+1]=(3&i)<<6|(224&a)>>2,h.data[n+2]=a<<3&248,h.data[n+3]=255,d%(2*s.width)==0?n=r-=4*s.width:n+=4;else for(d=0;d<o;d+=2)a=t.charCodeAt(d),i=t.charCodeAt(d+1),h.data[n]=i<<1&248,h.data[n+1]=(3&i)<<6|(224&a)>>2,h.data[n+2]=a<<3&248,h.data[n+3]=255,n+=4;return h}static strRepeat(t,e){if(e<1)return"";for(var a="";0<e;)1&e&&(a+=t),e>>=1,t+=t;return a}rleDecode(t){var e,a,i,s="",h=0,n=1;for(128==t.charCodeAt(0)&&(n=t.charCodeAt(1),h=2);h<t.length;)128<(e=t.charCodeAt(h))?(i=e-128,a=t.substr(h+1,n),s+=o.strRepeat(a,i),h+=n+1):(s+=t.substr(h+1,e),h+=e+1);return s}enforceShow(){var e,a;(this.view.tab||this.view.window)&&(this.view.window&&(e=this.view.window,chrome.runtime.sendMessage({getWindow:!0,windowId:this.view.window,data:{}},t=>{i("Error while loading show window: "+e)(),t?chrome.runtime.sendMessage({windowsUpdate:!0,windowId:this.view.window,winData:{focused:!0,state:"fullscreen"}}):(this.endShow(),this.startShow())})),this.view.tab&&(a=this.view.tab,chrome.runtime.sendMessage({getTab:!0,tabID:this.view.tab},function(t){i("Error while loading show tab "+a)(),t||(this.isShowing=0,this.view.tab=void 0,window.clearInterval(this.showInterval),this.startShow())})))}startShow(){this.isShowing||chrome.runtime.sendMessage({queryTabs:!0,tabData:{currentWindow:!0,active:!0}},t=>{this.lastTab=void 0,t[0]&&(this.lastTab=t[0].id),this.showHold&&window.clearTimeout(this.showHold),r.powerMode="display",chrome.runtime.sendMessage({requestKeepAwake:!0,powerMode:r.powerMode}),this.isFullScreen?chrome.runtime.sendMessage({createWindow:!0,windowData:{url:"show.html",top:0,left:0,type:"popup",width:screen.width,height:screen.height}},t=>{this.view.window=t.id}):chrome.runtime.sendMessage({createTab:!0,tabData:{url:"show.html"}},t=>{t?this.view.tab=t.id:!chrome.runtime.lastError||(t=chrome.runtime.lastError.message)&&"No current window"==t&&chrome.runtime.sendMessage({createWindow:!0,windowData:{url:"show.html",top:0,left:0,type:"normal",width:screen.width,height:screen.height}},t=>{chrome.runtime.sendMessage({queryTabs:!0,tabData:{windowId:t.id,active:!0}},t=>{t&&t[0]&&(this.view.tab=t[0].id)})})}),this.showInterval=window.setInterval(this.enforceShow,500),this.isShowing=1})}Scale(s,h){var n=Math.min(1,h/r.Show.Width),o=Math.min(1,s/r.Show.Height);this.scaleToFit?r.get.currentWindow().then(function(t){var e,a=Math.min(t.height/s,t.width/h),i=this.isFullScreen?Math.max(n,o)*a:Math.min(n,o);this.displayCanvas.style.webkitTransformOrigin="50% 50%",1.06<=a&&(e=Math.min(1,t.width/r.Show.Width),t=Math.min(1,t.height/r.Show.Height),i=Math.max(e,t),this.displayCanvas.style.webkitTransform="scale("+i+")"),.95<a&&a<1.06&&(i=Math.min(n,o),this.displayCanvas.style.webkitTransform="scale("+i+")"),a<=.95&&(this.displayCanvas.style.webkitTransform="scale("+i+")")}):this.displayCanvas.style.webkitTransform="scale(1)",this.displayCanvas&&this.Width&&(expandCanvas.call(this.displayCanvas,this.Width,this.Height)&&this.displayContext.drawImage(this.backBufferCanvas,0,0),expandCanvas.call(this.backBufferContext,this.Width,this.Height)&&this.backBufferContext.drawImage(this.displayCanvas,0,0))}PushFragment(t,e,a){this.fragments.push({xpos:t,ypos:e,imagedata:a})}expandCanvas(t,e){return(this.height!=e||this.width!=t)&&(this.height=e,this.width=t,!0)}}return new o});