var NSLibrary=NSLibrary||{};!function(e,o){"function"==typeof define&&define.amd?define(["student","accept","background/subscription","background/thumb/videoStream","models/Tab","models/TabData","modules/extension","comms.websocket","comms.nc.protocol","comms.webrtc","modules/debug","on/lifecycle","models/nodeinfo","models/webdata","modules/altdebug"],o):"object"==typeof exports?module.exports=o(require("student"),require("accept"),require("background/subscription"),require("background/thumb/videoStream"),require("models/Tab"),require("models/TabData"),require("modules/extension"),require("comms.websocket"),require("comms.nc.protocol"),require("comms.webrtc"),require("modules/debug"),require("models/nodeinfo"),require("modules/altdebug")):e.console.debug(e)}(this,function(r,i,e,o,n,t,c,a,s,d,l,u,g,C,m){var{}=window,E=i();function S(e){return e.split("").map(e=>e.charCodeAt(0))}function f(e,o){if(!o)return!1;if(e.length>o.length)return!1;for(var n in e)if(e[n]!==o[n])return!1;return!0}function O(o){if(-1!=o.indexOf("REDIRECT=")){let e=o.substring(o.indexOf("REDIRECT=")+9,o.indexOf("\n",o.indexOf("REDIRECT=")+10));null!=e&&""!=e&&(localStorage.gatewayAddress=e.split(":")[0],localStorage.port=e.split(":")[1],c.setGWFlag(1),require(["lib/batch"],function(e){e=e.squash(e.token.recycleSocket,3500);e.expire().then(e).then(function(){require(["comms.websocket"],function(e){e.mechanism.recycle()})})}))}}function N(o){require(["modules/ciccore"],function(e){"expired"==o||"18"==o?e.core.badge.updateBadgeColour("disconnected"):"1"==o?e.core.badge.updateBadgeColour("connected_NCS"):e.core.badge.updateBadgeColour("cloudstate")})}function T(e){var o=e.indexOf(10)+1,n=e.indexOf(10,o);return String.fromCharCode.apply(String,e.subarray(o,n)).replace("PIN=","")}function I(){l("ACK"),e.on.ackTimeout.clearInterval(),u.isActive()}function D(o){let e;try{e=JSON.parse(o)}catch(e){return o}return d&&d.message(o),e}function A(){require(["modules/ciccore"],function(e){e.core.updateBrowserActionStatus(0,!1)})}function G(){require(["modules/ciccore"],function(e){e.core.unMuteSound()})}return signatures={prefix:S("CMD="),OPEN_REPLY:S("CMD=OPEN_REPLY"),CONNECT:S("CMD=CONNECT"),HANGUP:S("CMD=HANGUP"),PIN_RESULT:S("CMD=PIN_RESULT"),PIN_CLEAR_RESULT:S("CMD=PIN_CLEAR_RESULT"),ACK:S("CMD=ACK"),CONFIG_UPDATE:[67,77,68,61,67,79,78,70,73,71,95,85,80,68,65,84,69],SGCONFIG_CHANGED:S("CMD=SGCONFIG_CHANGED"),TECHCONFIG_CHANGED:S("CMD=TECHCONFIG_CHANGED"),WEBCONFIG_CHANGED:S("CMD=WEBCONFIG_CHANGED"),SGROUP_CHANGED:S("CMD=SGROUP_CHANGED"),UPDATE_INVENTORY:S("CMD=UPDATE_INVENTORY"),CLOSE:[67,77,68,61,67,76,79,83,69],OTHER:S("CMD="),BROADCASTDATA:S("CMD=BROADCASTDATA")},chrome.runtime.onMessage.addListener(function(e,o,n){1!=e.sendClassCode&&1!=e.cancelJoinClass||(a.instance.STATUS_CLASSCODE(e.classCode,0),m.altdebug("273 STATUS_CLASSCODE - classCode: "+e.classCode))}),commands={signatures:signatures,match:f,process:{OPEN_REPLY:function(e){m.altdebug("99 comms.commands - OPEN_REPLY"),r.ServerVersion=e.substring(e.indexOf("SERVER_VERSION=")+15,e.indexOf("\n",e.indexOf("SERVER_VERSION=")+15)),gUsedMacAddress=e.substring(e.indexOf("MAC=")+4,e.indexOf("\n",e.indexOf("MAC=")+4)),sconfig_time=-1!=e.indexOf("SGCONFIG_TIME=")?e.substring(e.indexOf("SGCONFIG_TIME=")+14,e.indexOf("\n",e.indexOf("SGCONFIG_TIME=")+14)):"",sgroup=e.substring(e.indexOf("SGROUP=")+7,e.indexOf("\n",e.indexOf("SGROUP=")+7)),refresh_sconfig=e.substring(e.indexOf("REFRESH_SGCONFIG=")+17,e.indexOf("\n",e.indexOf("REFRESH_SGCONFIG=")+17)),refresh_webconfig=e.substring(e.indexOf("REFRESH_WEBCONFIG=")+18,e.indexOf("\n",e.indexOf("REFRESH_WEBCONFIG=")+18)),webconfig_time=-1!=e.indexOf("WEBCONFIG_TIME=")?e.substring(e.indexOf("WEBCONFIG_TIME=")+15,e.indexOf("\n",e.indexOf("WEBCONFIG_TIME=")+15)):"","1"==refresh_sconfig||null!=localStorage.sgroup&&sgroup!=localStorage.sgroup?require(["modules/cicregistration","modules/ciccrypto"],function(e,o){o.updateDevice().then(function(){setTimeout(function(){e.cic.esafetyConfig(localStorage.deviceID,localStorage.accountID,localStorage.region,null),e.cic.activityMonitorConfig(localStorage.deviceID,localStorage.accountID)},2e3)})}):require(["background/confighandler"],function(e){var o=localStorage.esafetyConfigData;null!=o&&""!=o&&(data=localStorage.esafetyConfigData,e.update(JSON.parse(data),!1));o=localStorage.activityMonitorConfigData;null!=o&&""!=o&&(data=localStorage.activityMonitorConfigData,e.update(JSON.parse(data),!1))}),localStorage.sgroup=sgroup,sessionStorage.room=localStorage.roomspec,r.Opened=!0,-1!=e.indexOf("EXPIRED=")?(expired=e.substring(e.indexOf("EXPIRED=")+8,e.indexOf("EXPIRED=")+9),"1"==expired?(localStorage.expired="1",localStorage.cloudState="18",require(["comms.websocket"],function(e){e.instance.CLOUD_STATUS("18")}),N("expired")):(localStorage.expired="0",require(["modules/cicregistration"],function(e){var o=e.cic.cloudstate();localStorage.cloudState=o,require(["comms.websocket"],function(e){e.instance.CLOUD_STATUS(o)}),N(CLOUDSTATE)}))):-1!=e.indexOf("REFRESH_CONFIG=")?(refreshConfig=e.substring(e.indexOf("REFRESH_CONFIG=")+15,e.indexOf("REFRESH_CONFIG=")+16),"1"===refreshConfig&&require(["modules/cicregistration"],function(e){m.altdebug("193 comms.commands - REFRESH_CONFIG"),e.cic.config()})):e.indexOf(!0)&&(localStorage.webconfigtime=webconfig_time,refresh_webconfig=e.indexOf("REFRESH_WEBCONFIG="),"1"==refresh_webconfig&&require(["modules/cicregistration"],function(e){e.cic.getInternetRestrictionsConfig(localStorage.deviceID,localStorage.accountID,localStorage.region,null)})),externalIP=e.substring(e.indexOf("EXTERNAL=")+9,e.indexOf("\n",e.indexOf("EXTERNAL=")+10)),localStorage.externalIPFromGateway=externalIP,localStorage.ipaddress=externalIP,m.altdebug("219 OPEN_REPLY - EXTERNAL IP ADDRESS: "+externalIP),require(["modules/cicregistration"],function(e){CLOUDSTATE=e.cic.isIpInvalid(localStorage.ipaddress,localStorage.allowedConnectionIPs,"privacy")?"20":"undefined"!=localStorage.cloudState?localStorage.cloudState:"1",chrome.runtime.sendMessage({storeLocal:!0,data:{cloudState:CLOUDSTATE}}),localStorage.cloudState=CLOUDSTATE,N(CLOUDSTATE)}),O(e)},CONNECT:function(e){var o,n,t;require(["modules/ciccore"],function(e){e.core.initiateBrowserActionStatus()}),m.altdebug("361 comms.commands - CONNECT"),window&&window.chrome&&(localStorage.connectionState="connected_TUTOR",chrome.runtime.sendMessage({storeLocal:!0,data:{connectionState:"connected_TUTOR"}}),l("CONNECT RECEIVED"),clearTimeout(r.reconnectMode.expiryHandler),cidIndex=e.indexOf("CONNECTION_ID="),termIndex=e.indexOf("\n",cidIndex+14),cidt=e.substring(cidIndex+14,termIndex),r.powerMode="system",chrome.runtime.sendMessage({requestKeepAwake:!0,powerMode:r.powerMode}),l("(CONNECT) Request KeepAwake: "+r.powerMode),l("CONNECTION ESTABLISH CID: "+cidt),r.ControlName=e.substring(e.indexOf("CONTROL_NAME=")+13,e.indexOf("\n",e.indexOf("CONTROL_NAME=")+13)),cid=String.fromCharCode(255&cidt,cidt>>8&255,cidt>>16&255,cidt>>>24&255),a.instance.CONNECT_REPLY(cidt),t=String.fromCharCode(s.FLUSH,0,1,64,24,0,0,1,159,13,0,0,224,7),c.senddata(cid,t),E="1"==localStorage.getItem("useracknowledge")?i("ack"):i(),c.senddata(cid,E),r.Connections[cid]=(o=cid,n=cidt,(t={stream:"",thumbi:0,thumbs:0,thumbw:0,thumbh:0,thumblast:"",webpoll:0,appidlast:0,apptitlelast:"",weburllast:"",webtitlelast:"",redirect:"",includes:[],excludes:[],webflag:0,utf8:!(e=1)}).cid=o,t.cidt=n,t.sm=e,t.thumbnailType="image/png",t),m.altdebug("473 Connection "+cid+" added comms.commands"),m.altdebug("474 Connections[] "+Object.keys(r.Connections).length+" comms.commands"),localStorage.connection=JSON.stringify(r.Connections[cid]),r.ActiveConnection=r.Connections[cid],r.tickle[cid]&&window.clearInterval(r.tickle[cid]),r.tickle[cid]=window.setInterval(function(){c.senddata(cid,String.fromCharCode(s.TICKLE,0))},6e4))},HANGUP:function(){return!1},PIN_RESULT:T,PIN_CLEAR_RESULT:function(e){var o=e.indexOf(10)+1,n=e.indexOf(10,o);return String.fromCharCode.apply(String,e.subarray(o,n)).replace("RESULT=","")},CONFIG_UPDATE:function(e){m.altdebug("263 comms.commands - CONFIG_UPDATE"),refreshConfig=e.substring(e.indexOf("REFRESH=")+8,e.indexOf("REFRESH=")+9),expired=e.substring(e.indexOf("EXPIRED=")+8,e.indexOf("EXPIRED=")+9),null==expired||null==expired||"1"!==expired&&"0"!==expired||("1"==expired?(localStorage.expired="1",localStorage.cloudState="18",localStorage.roomspec="","undefined"!=localStorage.initiateBrowserActionStatusInterval&&window.clearInterval(parseInt(localStorage.initiateBrowserActionStatusInterval)),chrome.runtime.sendMessage({endScreenshare:!0}),chrome.runtime.sendMessage({storeLocal:!0,data:{connectionState:"disconnected"}}),require(["comms.websocket"],function(e){e.instance.CLOUD_STATUS("18"),N("expired")})):(localStorage.expired="0",require(["modules/cicregistration","comms.websocket"],function(e,o){e=e.cic.cloudstate();localStorage.cloudState=e,o.instance.CLOUD_STATUS(e),N(CLOUDSTATE)}))),"1"===refreshConfig&&(m.altdebug("290 comms.commands - REFRESH CONFIG"),require(["modules/cicregistration"],function(e){e.cic.config()}))},SGCONFIG_CHANGED:function(e){m.altdebug("337 comms.commands - SGCONFIG_CHANGED"),sconfig_time=e.substring(e.indexOf("SGCONFIG_TIME=")+14,e.indexOf("\n",e.indexOf("SGCONFIG_TIME=")+14)),localStorage.lastSconfigTime=sconfig_time,require(["modules/cicregistration"],function(e){e.cic.esafetyConfig(localStorage.deviceID,localStorage.accountID,localStorage.region,null)})},TECHCONFIG_CHANGED:function(e){require(["modules/cicregistration"],function(e){m.altdebug("353 comms.commands - TECHCONFIG_CHANGED"),e.cic.activityMonitorConfig(localStorage.deviceID,localStorage.accountID)})},WEBCONFIG_CHANGED:function(e){m.altdebug("380 comms.commands - WEBCONFIG_CHANGED"),webconfig_time=-1!=e.indexOf("CONFIG_TIME=")?e.substring(e.indexOf("CONFIG_TIME=")+12,e.indexOf("\n",e.indexOf("CONFIG_TIME=")+12)):"",localStorage.webconfigtime=webconfig_time,require(["modules/cicregistration"],function(e){e.cic.getInternetRestrictionsConfig(localStorage.deviceID,localStorage.accountID,localStorage.region,null)})},SGROUP_CHANGED:function(e){m.altdebug("308 comms.commands - SGROUP_CHANGED"),sgroup=e.substring(e.indexOf("SGROUP=")+7,e.indexOf("\n",e.indexOf("SGROUP=")+7)),refresh_sconfig=e.substring(e.indexOf("REFRESH_SGCONFIG=")+17,e.indexOf("\n",e.indexOf("REFRESH_SGCONFIG=")+17)),"1"!=refresh_sconfig&&sgroup==localStorage.sgroup||require(["modules/cicregistration"],function(e){m.altdebug("321 comms.commands - calling esafetyConfig()"),e.cic.esafetyConfig(localStorage.deviceID,localStorage.accountID,localStorage.region,null)}),localStorage.sgroup=sgroup},UPDATE_INVENTORY:function(e){require(["modules/ciccore"],function(e){m.altdebug("300 comms.commands - UPDATE_INVENTORY"),e.core.updateHardwareInventory(!1),e.core.updateSoftwareInventory()})},CLOSE:function(e){O(e)},BROADCASTDATA:function(o){require(["modules/ciccore"],function(e){e.core.showBroadcastMessage(o)})},ACK:I},interpret:{string:function(e){var o="64 - ",n=(t=(e=e?`${e}`:"").match(/^(cmd=)([^\n]+)?/i)||[null,null,null])[1],t=t[2];return e&&!n?(D(e),e):n&&/^json$/i.test(t)?(D((e.match(/cmd=json\ndata=([^\n]+)\n/i)||[null,null])[1]),e):("CMD=OPEN_REPLY\n"===e.substr(0,15)?(l(o+"OPEN_REPLY"),commands.process.OPEN_REPLY(e)):"CMD=CONNECT\n"===e.substr(0,12)?(l(o+"CONNECT"),commands.process.CONNECT(e)):"CMD=HANGUP"===e.substr(0,10)?(l(o+"HANGUP"),localStorage.hangupCalled=!0,localStorage.hangupReceived=!0,localStorage.connectedToTutor=!1,localStorage.offlineConnection=void 0,commands.process.HANGUP(e),localStorage.offlineLock=!1,localStorage.offlineMuteFlag=0,clearTimeout(localStorage.unlockTimeout),A(),G(),chrome.runtime.sendMessage({closeAcknowledgeDialog:!0})):"CMD=PIN_RESULT"==e.substr(0,14)?(o=e.split("\n"),gPin=o[1].replace("RESULT=","")):"CMD=ACK"==e.substr(0,7)?I():"CMD=CONFIG_UPDATE"==e.substr(0,17)?commands.process.CONFIG_UPDATE(e):"CMD=SGCONFIG_CHANGED"==e.substr(0,20)?commands.process.SGCONFIG_CHANGED(e):"CMD=WEBCONFIG_CHANGED"==e.substr(0,17)?commands.process.WEBCONFIG_CHANGED(e):"CMD=AMCONFIG_CHANGED"==e.substr(0,20)?commands.process.AMCONFIG_CHANGED(e):"CMD=SGROUP_CHANGED"==e.substr(0,18)?commands.process.SGROUP_CHANGED(e):"CMD=UPDATE_INVENTORY"==e.substr(0,20)?commands.process.UPDATE_INVENTORY(e):"CMD=CLOSE"==e.substr(0,9)?commands.process.CLOSE(e):"CMD=BROADCASTDATA"==e.substr(0,17)?commands.process.BROADCASTDATA(e):"CMD="==e.substr(0,4)&&l("CMD message Unknown"+e),t)},binary:function(e){var o,n="0x - ";if(!f(commands.signatures.prefix,e))return!1;f(signatures.OPEN_REPLY,e)?(l(n+"OPEN_REPLY"),o=a.Commands.convertBinaryToString(e,e.byteLength),commands.process.OPEN_REPLY(o)):f(signatures.CONNECT,e)?(l(n+"CONNECT"),o=a.Commands.convertBinaryToString(e,e.byteLength),commands.process.CONNECT(o)):f(signatures.HANGUP,e)?(l(n+"HANGUP"),localStorage.hangupCalled=!0,localStorage.hangupReceived=!0,localStorage.connectedToTutor=!1,localStorage.offlineConnection=void 0,localStorage.offlineLock=!1,localStorage.offlineMuteFlag=0,clearTimeout(localStorage.unlockTimeout),o=a.Commands.convertBinaryToString(e,e.byteLength),commands.process.HANGUP(o),A(),G(),chrome.runtime.sendMessage({closeAcknowledgeDialog:!0})):f(signatures.PIN_RESULT,e)?gPin=T(e):f(signatures.PIN_CLEAR_RESULT,e)||(f(signatures.ACK,e)?I():f(signatures.CONFIG_UPDATE,e)?(l(n+"CONFIG_UPDATE"),o=a.Commands.convertBinaryToString(e,e.byteLength),commands.process.CONFIG_UPDATE(o)):f(signatures.SGCONFIG_CHANGED,e)?(o=a.Commands.convertBinaryToString(e,e.byteLength),commands.process.SGCONFIG_CHANGED(o)):f(signatures.TECHCONFIG_CHANGED,e)?(o=a.Commands.convertBinaryToString(e,e.byteLength),commands.process.TECHCONFIG_CHANGED(o)):f(signatures.WEBCONFIG_CHANGED,e)?(o=a.Commands.convertBinaryToString(e,e.byteLength),commands.process.WEBCONFIG_CHANGED(o)):f(signatures.SGROUP_CHANGED,e)?(o=a.Commands.convertBinaryToString(e,e.byteLength),commands.process.SGROUP_CHANGED(o)):f(signatures.UPDATE_INVENTORY,e)?(o=a.Commands.convertBinaryToString(e,e.byteLength),commands.process.UPDATE_INVENTORY(o)):f(signatures.CLOSE,e)?(o=a.Commands.convertBinaryToString(e,e.byteLength),commands.process.CLOSE(o)):f(signatures.BROADCASTDATA,e)&&(o=a.Commands.convertBinaryToString(e,e.byteLength),commands.process.BROADCASTDATA(o)))}}},commands});