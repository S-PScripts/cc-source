!function(e){"function"==typeof define&&define.amd?define(["student","modules/debug","modules/extension","models/Tab","background/thumb/videoStream","modules/altdebug"],e):"object"==typeof exports&&(module.exports=e(require("student"),require("modules/debug"),require("modules/extension"),require("models/Tab"),require("background/thumb/videoStream"),require("modules/altdebug")))}(function(h,i,c,r,d,u){let g={takeScreenshot:function(e){null!=localStorage.getItem("prevWidth")&&localStorage.getItem("prevWidth")!=screen.width&&(null!=localStorage.tracks&&(localStorage.tracks.forEach(function(e){e.stop()}),localStorage.vid=null),screen.width>screen.height&&a(screen.width,screen.height),localStorage.setItem("prevWidth",screen.width),localStorage.wasPortraitAndActive=!1);return t(!0,e).then(function(o){return localStorage.setItem("prevWidth",screen.width),new Promise(function(e,t){for(var a in h.Connections){let t=h.Connections[a];var{thumbw:n,thumbh:i,thumbnailType:r,thumblast:s}=t;for(targetDimensions=d.isActive()?(screen.availWidth<screen.height&&(localStorage.wasPortraitAndActive=!0),l(screen.availWidth,screen.height,n,i)):screen.availWidth<screen.height?l(screen.height,screen.availWidth,n,i):(screen.availWidth<screen.height&&localStorage.wasPortraitAndActive,l(screen.availWidth,screen.height,n,i)),targetWidth=Math.round(targetDimensions.width),targetHeight=Math.round(targetDimensions.height),last2digits=targetWidth%100;last2digits%4!=0;)targetWidth+=1,last2digits=targetWidth%100;if(g.canvas||(u.altdebug("API.canvas undefined"),chrome.runtime.sendMessage({createCanvas:!0})),g.canvas){g.canvas.width=n,g.canvas.height=i,xPos=Math.round((n-targetWidth)/2),g.context.drawImage(g.hiDPICanvas,xPos,0,targetWidth,i);let e=g.canvas.toDataURL(r,.7);e!=s&&1==o&&(t.thumblast=e,s=e.indexOf(","),c.senddata(a,String.fromCharCode(191,0)+atob(e.substr(s+1)))),t.thumbs=0}}})}(e))},bareScreenshot:function(){return t()},canvas:void 0,hiDPICanvas:void 0,tabCanvas:document.createElement("canvas"),setDisplaySize:a},s;function t(a,n){return new Promise(function(e,t){i("in Take SS"),g.hiDPICanvas||(g.hiDPICanvas=d.getCanvas()),g.canvas&&!g.context&&(g.context=g.canvas.getContext("2d")),a&&r.PollActive(),(d.isActive()&&"true"!=localStorage.shareScreenClosed&&null!=s&&"false"!=localStorage.isDesktopCaptureOpen?o(s):new Promise(function(i,e){chrome.runtime.sendMessage({captureVisibleTab:!0}),chrome.runtime.onMessage.addListener(function(e,t,a){var n;1==e.captureVisibleTabThumbnails&&(n=chrome.runtime.lastError,e.img,n&&n.message&&("Failed to capture tab: unknown error"==n.message||-1!==n.message.search(/(chrome-)*devtools:\/\//)||console.debug("unable to capture tab: "+n.message)),e.img&&i(e.img))})}).then(o)).then(e,n)})}function a(e,t){g.tabCanvas.width=e,g.tabCanvas.height=t,d.setDisplaySize(e,t)}function l(e,t,a,n){n=Math.min(a/e,n/t);return{width:e*n,height:t*n}}function o(a){return new Promise((t,e)=>{img=document.createElement("img"),img.onload=function(e){var h;h=e.target,new Promise((e,t)=>{var{width:a,height:n}=g.hiDPICanvas,i=g.hiDPICanvas.getContext("2d");i.fillRect(0,0,a,n);var r=void 0,s=a/n<h.width/h.height?a/h.width:n/h.height,o={width:h.width*s,height:h.height*s};i.drawImage(h,(r={x:(a-o.width)/2,y:(n-o.height)/2}).x,r.y,o.width,o.height),e(g.hiDPICanvas)}).then(t)},img.onerror=e,img.src=a,img=null})}return chrome.runtime.onMessage.addListener(function(e,t,a){return 1==e.sendDesktopImageDataURLForImage&&(s=e.desktopImageDataURL),!0}),require(["modules/ciccore"],function(e){e.core.processFrames(g)}),g});