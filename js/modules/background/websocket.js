!function(e){"function"==typeof define&&define.amd?define(["comms","models/connectiondetails","models/nodeinfo","models/hardware","models/software","models/webdata","models/logindata","background/storage","lib/batch","background/thumbnail","logger","background/messageQueue","background/confighandler","models/sites","modules/ciccrypto","background/storageSync","modules/altdebug","modules/ciccore"],e):"object"==typeof exports&&(module.exports=e(require("comms"),require("models/connectiondetails"),require("models/nodeinfo"),require("models/hardware"),require("models/software"),require("models/webdata"),require("models/logindata"),require("background/storage"),require("background/storageSync"),require("lib/batch"),require("background/thumbnail"),require("logger"),require("background/messageQueue"),require("background/confighandler"),require("models/sites"),require("modules/ciccrypto"),require("modules/altdebug"),require("modules/ciccore")))}(function(e,t,l,a,o,r,c,d,u,g,m,S,h,f,I,y,O,w){var v,T,D,A="",b="",H=null,k=!1;function _(e){var o,r;e&&(e.phrasematch&&U(e).then(function(){S.priority.dequeue(),S.notify()}).catch(function(e){m.info("phrase transmit delayed",e)}),e.concernData&&(r=e,new Promise(function(t,a){Promise.all([l.webheader(),new Promise(function(e){e({esafety:r})})]).then(function(e){var o;o=e,new Promise(function(e,t){var s,a={UserID:o[1].esafety.concernData.contactid,Concern:o[1].esafety.concernData.message,Username:o[1].esafety.concernData.name,ReportedTime:V(new Date),LoggedOnUserDisplayName:"true"==localStorage.googleAdminAccess&&"true"==localStorage.isManaged&&null!=localStorage.name?localStorage.name:localStorage.userName.split("@")[0],LoggedOnUsername:localStorage.userName.split("@")[0]},a={DeviceID:localStorage.deviceID,SafeguardingGroupID:parseInt(localStorage.sgroup),Concern:a};null!=a?(s=a,new Promise(function(a,o){const r=new XMLHttpRequest,n="blob";I.encrypt(JSON.stringify(s.Concern)).then(function(e){var t={DeviceID:s.DeviceID,SafeguardingGroupID:s.SafeguardingGroupID,Concern:e},e="\r\n";e+="--blob\r\n",e+="content-disposition: form-data; name=concerns\r\n",e+="\r\n",e+=JSON.stringify(t)+"\r\n",e+="--blob--";t=(new TextEncoder).encode(e),e=new Uint8Array(t.length);e.set(t,0),Q(localStorage.region)||"nsclassroomapi"==localStorage.region?r.open("POST","https://nsclassroomsafeguardingapi.azurewebsites.net/api/concerns/netsupport?encryptionVersion=1"):r.open("POST","https://safeguardingapi-"+localStorage.region+".classroom.cloud/api/concerns/netsupport?encryptionVersion=1"),r.setRequestHeader("Content-Type","multipart/form-data; boundary="+n),r.send(e),r.onreadystatechange=function(){this.readyState===r.DONE&&200===this.status?(chrome.runtime.sendMessage({createWindow:!0,windowData:{url:"concernsentconfirmation.html",focused:!0,type:"popup",width:600,height:120,left:parseInt((screen.width-600)/2),top:parseInt((screen.height-120)/4)}},function(){}),a()):(0==this.status&&o(),429==this.status&&(null==H||H+2e3<(new Date).getTime())&&(H=(new Date).getTime(),chrome.runtime.sendMessage({queryTabs:!0,tabData:{active:!0}},e=>{var t,a=!1;for(t of e)if(t.url===chrome.runtime.getURL("concerntryagainlater.html")){a=!0;break}a||chrome.runtime.sendMessage({createWindow:!0,windowData:{url:"concerntryagainlater.html",focused:!0,type:"popup",width:600,height:120,left:parseInt((screen.width-600)/2),top:parseInt((screen.height-120)/4)}},function(){})})))},r.onerror=function(){chrome.runtime.sendMessage({queryTabs:!0,tabData:{active:!0}},e=>{var t,a=!1;for(t of e)if(t.url===chrome.extension.getURL("concerncannotsend.html")){a=!0;break}a||chrome.runtime.sendMessage({createWindow:!0,windowData:{url:"concerncannotsend.html",focused:!0,type:"popup",width:600,height:120,left:parseInt((screen.width-600)/2),top:parseInt((screen.height-120)/4)}},function(){})})}})}).then(e).catch(t)):e()}).then(t).catch(a)})}).then(function(){S.priority.dequeue(),S.notify()}).catch(function(e){m.info("concern transmit delayed",e)})),e.video&&(o=e,new Promise(function(t,a){Promise.all([l.webheader(),new Promise(function(e){e({esafety:o})})]).then(function(e){var l;l=e,new Promise(function(e,t){var o,r,n,a=l[1],s=a.esafety.video.data,i=JSON.parse(a.esafety.video.matches),a=Y()+".webm";b!=i[0]?(b=i[0],i={DeviceID:localStorage.deviceID,PhraseMatches:i},o=i,r=s,n=a,new Promise(function(e,t){var a,s,i;a=r,s=o,i=n,new Promise(function(r,n){var e=new XMLHttpRequest;e.open("GET",a,!0),e.responseType="arraybuffer",e.onload=function(e){var t,a,o;200==this.status&&(videoArrayBuffer=new Uint8Array(this.response),t=new Array(videoArrayBuffer),a=s,o=i,new Promise(function(l,c){I.encrypt(JSON.stringify(a.PhraseMatches)).then(function(e){e={DeviceID:localStorage.deviceID,PhraseMatches:e};const r=new XMLHttpRequest,n="blob";let s="";s+="--blob\r\n",s+='content-disposition: form-data; name="'+o+'"; filename="'+o+'"\r\n',s+="Content-Type: video/webm\r\n",s+="\r\n";var i="\r\n";i+="--blob\r\n",i+="content-disposition: form-data; name=phrasematches\r\n",i+="\r\n",i+=JSON.stringify(e)+"\r\n",i+="--blob--",new Blob(t,{type:"video/webm"}).arrayBuffer().then(function(e){var t=new Uint8Array(e),a=new Uint8Array(s.length+t.length+i.length),o=(new TextEncoder).encode(s),e=(new TextEncoder).encode(i);a.set(o,0),a.set(t,o.length),a.set(e,t.length+o.length),Q(localStorage.region)||"nsclassroomapi"==localStorage.region?r.open("POST","https://nsclassroomsafeguardingapi.azurewebsites.net/api/phrasematches/video2"):r.open("POST","https://safeguardingapi-"+localStorage.region+".classroom.cloud/api/phrasematches/video2"),r.setRequestHeader("Content-Type","multipart/form-data; boundary="+n),r.send(a),r.onreadystatechange=function(){this.readyState!==r.DONE||204!==this.status&&200!==this.status?0==this.status&&(c(),$()):l()}})})}).then(r).catch(n))},e.onerror=function(e){n()},e.send()}).then(e).catch(t)}).then(e).catch(t)):e()}).then(t).catch(a)})}).then(function(){S.priority.dequeue(),S.notify()}).catch(function(e){m.info("video transmit delayed",e)})))}function M(){S.priority.peek(_)}function N(e){return m.debug("internet"),Promise.all([r.internet()])}function x(){return m.debug("login"),c.logins()}function U(o){return new Promise(function(t,a){Promise.all([l.webheader(),new Promise(function(e){e({esafety:o})})]).then(function(e){var r;r=e,new Promise(function(t,a){let H=r[1],o=null!=H.esafety.phrasematch.screenshot?H.esafety.phrasematch.screenshot.data:null,k,O="true"==localStorage.googleAdminAccess&&"true"==localStorage.isManaged&&null!=localStorage.name?localStorage.name:H.esafety.phrasematch.user.split("@")[0];chrome.runtime.sendMessage({getLocal:!0,data:"connectionState"},function(e){for(classActive="connected_TUTOR"==e.connectionState,k={DeviceID:localStorage.deviceID,PhraseMatches:[]},i=0;i<H.esafety.phrasematch.results.length;i++)if(null!=H.esafety.phrasematch.results[i]&&A!=H.esafety.phrasematch.results[i].id){var r=H.esafety.phrasematch.results[i].id,s=H.esafety.phrasematch.results[i].priority,l=2<parseInt(s)?Y()+".jpg":null,c=H.esafety.phrasematch.user;let e=H.esafety.phrasematch.phrase;var d=H.esafety.phrasematch.results[i].matchedPhrase,u=H.esafety.phrasematch.results[i].confidence,g=(H.esafety.phrasematch.results[i].category>>>0).toString(2).length,m=H.esafety.phrasematch.phrasesource,p=H.esafety.phrasematch.executable,S=V(new Date(H.esafety.phrasematch.time)),h=e.indexOf(d),f=e.length,y=H.esafety.phrasematch.results[i].hasVideo,w=H.esafety.phrasematch.className,v=H.esafety.phrasematch.teacher;let t=!1,a=!1,o=e;if(256<o.length){for(z=0;z<256;z++){if(h-z==0){t=!0;break}if(h+z==o.length){a=!0;break}}1==t||1==a?(1==t&&(e=o.substr(0,256)),1==a&&(e=o.substr(o.length-256))):e=o.substr(h-128,256)}v={ID:r,Username:O,Typed:e,Matched:d,Threshold:u,Priority:parseInt(s),Category:g,Source:m,ExecutableOrUrl:p,MatchTime:S,MatchPosition:h,MatchCount:f,ScreenshotFilename:l,ClassActive:classActive,HasVideo:y,Email:c,ClassName:w,Teacher:v};k.PhraseMatches.push(v),A=H.esafety.phrasematch.results[i].id}var T,D,b;0!=k.PhraseMatches.length?(T=O,D=k,b=o,new Promise(function(s,l){const c=new XMLHttpRequest,d="blob";let e="",u=[];if(null!=b&&"null"!=b)for(i=0;i<D.PhraseMatches.length;i++){0!=i&&(e="\r\n"),e+="--blob\r\n",e+='content-disposition: form-data; name="'+D.PhraseMatches[i].ScreenshotFilename+'"; filename="'+D.PhraseMatches[i].ScreenshotFilename+'"\r\n',e+="Content-Type: image/jpeg\r\n",e+="\r\n";var t=function(e){e=e.split(",");let t=atob(e[1]);n=t.length;let a=new Uint8Array(n);for(;n--;)a[n]=t.charCodeAt(n);return a}(b),a=new Uint8Array(e.length+t.length),o=(new TextEncoder).encode(e);a.set(o,0),a.set(t,o.length),u.push(a)}I.encrypt(JSON.stringify(D.PhraseMatches)).then(function(e){var t={DeviceID:D.DeviceID,SafeguardingGroupID:parseInt(localStorage.sgroup),PhraseMatches:e,Username:T},e="\r\n";e+="--blob\r\n",e+="content-disposition: form-data; name=phrasematches\r\n",e+="\r\n",e+=JSON.stringify(t)+"\r\n",e+="--blob--";e=(new TextEncoder).encode(e);let a=0;for(i=0;i<u.length;i++)a+=u[i].length;let o=new Uint8Array(a+e.length),r=0;for(i=0;i<u.length;i++)i,o.set(u[i],r),r+=u[i].length;o.set(e,a),Q(localStorage.region)||"nsclassroomapi"==localStorage.region?c.open("POST","https://nsclassroomsafeguardingapi.azurewebsites.net/api/phrasematches/phrasematch2"):c.open("POST","https://safeguardingapi-"+localStorage.region+".classroom.cloud/api/phrasematches/phrasematch2"),c.setRequestHeader("Content-Type","multipart/form-data; boundary="+d),c.send(o),c.onreadystatechange=function(){this.readyState===c.DONE&&200===this.status?s():0==this.status&&(l(),$())}})}).then(t).catch(a)):t()})}).then(t).catch(a)})})}function P(n){return new Promise(function(o,r){chrome.runtime.sendMessage({getNetworkDetails:!0}),chrome.runtime.onMessage.addListener(function(e,t,a){1==e.getNetworkDetailsResponse&&(ipv6=e.network?(ipv4=null!=e.network.ipv4?e.network.ipv4:null,null!=e.network.ipv6?e.network.ipv6:null):ipv4=null,q(o,r,n,ipv4,ipv6))})})}function q(o,r,e,t,a){let n;e.name;var s=e.osname,l=e.cpuname,c=e.x64,d=(e.cpu_count,e.cpuspeed),u=e.cpumodel,g=e.cpumanufacturer,m=t,p=a,S=e.ram?-1!=e.ram.toString().indexOf(".00")?e.ram.toString().split(".")[0]:e.ram.toString():"",h=(e.displayresolution,e.colorDepth,e.videoCard),t=e.storageFixedTotal?-1!=e.storageFixedTotal.toString().indexOf(".00")?e.storageFixedTotal.toString().split(".")[0]:e.storageFixedTotal.toString():"",a=e.storageNumber;let f=e.osver;var y=e.displays,w=e.storageFixed,v=e.storageRemovable;n={accountID:localStorage.accountID,deviceID:localStorage.deviceID,updateRequest:!0,system:{deviceName:""!=localStorage.deviceHostname?localStorage.deviceHostname:localStorage.serialNumber,serialNumber:localStorage.serialNumber,assetTag:localStorage.deviceAssetId,manufacturer:localStorage.manufacturer,model:localStorage.model,location:localStorage.location,lastLoggedOnUser:"true"==localStorage.googleAdminAccess&&"true"==localStorage.isManaged&&null!=localStorage.name?localStorage.name:localStorage.userName.split("@")[0],totalStorage:"true"==localStorage.googleAdminAccess&&"true"==localStorage.isManaged&&null!=localStorage.totalStorage?parseFloat(localStorage.totalStorage):"0"==t?null:t,freeSpace:"true"==localStorage.googleAdminAccess&&"true"==localStorage.isManaged&&null!=localStorage.freeSpace?parseFloat(localStorage.freeSpace):null,totalMemory:null!=S?parseInt(S):null,formFactor:"Chromebook",numNetworkCards:1,numStorageDevices:"0"==a?1:parseInt(a)+1,timeZone:function(){const e=new Date,t=e.toLocaleDateString(void 0),a=e.toLocaleDateString(void 0,{timeZoneName:"long"}),o=a.indexOf(t);{if(0<=o){const r=a.substring(0,o)+a.substring(o+t.length);return r.replace(/^[\s,.\-:;]+|[\s,.\-:;]+$/g,"")}return a}}(),lastOSCheck:"true"==localStorage.googleAdminAccess&&"true"==localStorage.isManaged&&null!=localStorage.lastOSCheck?localStorage.lastOSCheck:null,autoUpdateExpiration:"true"==localStorage.googleAdminAccess&&"true"==localStorage.isManaged&&null!=localStorage.autoUpdateExpiration?localStorage.autoUpdateExpiration:null},operatingSystems:[{name:s,version:f.split("Chrome")[1].split(")")[0].trim()}],displayAdapters:[],cpUs:[{name:l,manufacturer:g,model:u,speed:d,type:c}],disks:[],networkAdapters:[{connection:localStorage.networkTypeInv,type:"Physical",linkSpeed:localStorage.downlink,status:"Connected",ipv4address:m,ipv6address:p}]};let T={name:h.renderer,videoMemory:null,monitors:[]};for(i=0;i<y.length;i++){var D={resolution:y[i].resolution,colorDepth:window.screen.colorDepth,name:y[i].name};T.monitors.push(D)}for(n.displayAdapters.push(T),n.system.numDisplays=y.length,i=0;i<w.length;i++){var b={type:"Fixed hard disk media",name:null,diskType:"SSD",totalCapacity:e.storageFixedTotal};n.disks.push(b)}for(0==w.length&&(k={type:"Fixed hard disk media",diskType:"SSD",totalCapacity:"true"==localStorage.googleAdminAccess&&"true"==localStorage.isManaged?parseFloat(localStorage.totalStorage):null},n.disks.push(k)),i=0;i<v.length;i++){var H={type:"Removable Media",totalCapacity:e.storageRemovableTotal};n.disks.push(H)}var k=JSON.stringify(n.system)+JSON.stringify(n.operatingSystems)+JSON.stringify(n.displayAdaptor)+JSON.stringify(n.cpUs)+JSON.stringify(n.disks)+JSON.stringify(n.networkAdapters);null==localStorage.hardwareDigestHexPrev||"undefined"==localStorage.hardwareDigestHexPrev?(O.altdebug("619 sendHardwareInventoryHTTP hardwareDigestHexPrev UNDEFINED"),E(k).then(function(e){null!=n?(n.checkSum=e,function(e){{var t;null!=e&&(localStorage.prev_deviceName=e.system.deviceName,localStorage.prev_serialNumber=e.system.serialNumber,localStorage.prev_assetTag=e.system.assetTag,localStorage.prev_manufacturer=e.system.manufacturer,localStorage.prev_model=e.system.model,localStorage.prev_location=e.system.location,localStorage.prev_lastLoggedOnUser=e.system.lastLoggedOnUser,localStorage.prev_totalStorage=e.system.totalStorage,localStorage.prev_freeSpace=e.system.freeSpace,localStorage.prev_totalMemory=e.system.totalMemory,localStorage.prev_formFactor=e.system.formFactor,localStorage.prev_numNetworkCards=e.system.numNetworkCards,localStorage.prev_numStorageDevices=e.system.numStorageDevices,localStorage.prev_timeZone=e.system.timeZone,localStorage.prev_lastOSCheck=e.system.lastOSCheck,localStorage.prev_autoUpdateExpiration=e.system.autoUpdateExpiration,localStorage.prev_numDisplays=e.system.numDisplays,localStorage.prev_osname=e.operatingSystems[0].name,localStorage.prev_osversion=e.operatingSystems[0].version,localStorage.prev_cpuName=e.cpUs[0].name,localStorage.prev_cpumanufacturer=e.cpUs[0].manufacturer,localStorage.prev_cpumodel=e.cpUs[0].model,localStorage.prev_speed=e.cpUs[0].speed,localStorage.prev_cputype=e.cpUs[0].type,localStorage.prev_connection=e.networkAdapters[0].connection,localStorage.prev_NetworkType=e.networkAdapters[0].type,localStorage.prev_linkSpeed=e.networkAdapters[0].linkSpeed,localStorage.prev_status=e.networkAdapters[0].status,localStorage.prev_ipv4Address=e.networkAdapters[0].ipv4address,localStorage.prev_ipv6address=e.networkAdapters[0].ipv6address,t=E(JSON.stringify(e.displayAdapters)).then(function(e){localStorage.prev_displayAdaptersDigest=e}),e=E(JSON.stringify(e.disks)).then(function(e){localStorage.prev_disksDigest=e}),Promise.all([t,e]))}}(n),R(n,!1,e).then(o).catch(r)):o()})):E(k).then(function(e){let t="";if(0!=e.localeCompare(localStorage.hardwareDigestHexPrev)){var a;null!=n?(localStorage.prev_deviceName==n.system.deviceName||(localStorage.prev_deviceName=n.system.deviceName),localStorage.prev_serialNumber==n.system.serialNumber?delete n.system.serialNumber:localStorage.prev_serialNumber=n.system.serialNumber,localStorage.prev_assetTag==n.system.assetTag?delete n.system.assetTag:localStorage.prev_assetTag=n.system.assetTag,localStorage.prev_manufacturer==n.system.manufacturer?delete n.system.manufacturer:localStorage.prev_manufacturer=n.system.manufacturer,localStorage.prev_model==n.system.model?delete n.system.model:localStorage.prev_model=n.system.model,localStorage.prev_location==n.system.location?delete n.system.location:localStorage.prev_location=n.system.location,localStorage.prev_lastLoggedOnUser==n.system.lastLoggedOnUser?delete n.system.lastLoggedOnUser:localStorage.prev_lastLoggedOnUser=n.system.lastLoggedOnUser,localStorage.prev_totalStorage==n.system.totalStorage?delete n.system.totalStorage:localStorage.prev_totalStorage=n.system.totalStorage,null==n.system.freeSpace||localStorage.prev_freeSpace==n.system.freeSpace?delete n.system.freeSpace:localStorage.prev_freeSpace=n.system.freeSpace,localStorage.prev_totalMemory==n.system.totalMemory?delete n.system.totalMemory:localStorage.prev_totalMemory=n.system.totalMemory,localStorage.prev_formFactor==n.system.formFactor?delete n.system.formFactor:localStorage.prev_formFactor=n.system.formFactor,localStorage.prev_numNetworkCards==n.system.numNetworkCards?delete n.system.numNetworkCards:localStorage.prev_numNetworkCards=n.system.numNetworkCards,localStorage.prev_numStorageDevices==n.system.numStorageDevices?delete n.system.numStorageDevices:localStorage.prev_numStorageDevices=n.system.numStorageDevices,localStorage.prev_timeZone==n.system.timeZone?delete n.system.timeZone:localStorage.prev_timeZone=n.system.timeZone,null==n.system.lastOSCheck||localStorage.prev_lastOSCheck==n.system.lastOSCheck?delete n.system.lastOSCheck:localStorage.prev_lastOSCheck=n.system.lastOSCheck,null==n.system.autoUpdateExpiration||localStorage.prev_autoUpdateExpiration==n.system.autoUpdateExpiration?delete n.system.autoUpdateExpiration:localStorage.prev_autoUpdateExpiration=n.system.autoUpdateExpiration,localStorage.prev_numDisplays==n.system.numDisplays?delete n.system.numDisplays:localStorage.prev_numDisplays=n.system.numDisplays,0===Object.keys(n.system).length?delete n.system:t+=JSON.stringify(n.system),localStorage.prev_osname==n.operatingSystems[0].name?delete n.operatingSystems[0].name:localStorage.prev_osname=n.operatingSystems[0].name,localStorage.prev_osversion==n.operatingSystems[0].version?delete n.operatingSystems[0].version:localStorage.prev_osversion=n.operatingSystems[0].version,0===Object.keys(n.operatingSystems[0]).length?delete n.operatingSystems:t+=JSON.stringify(n.operatingSystems),localStorage.prev_cpuName==n.cpUs[0].name?delete n.cpUs[0].name:localStorage.prev_cpuName=n.cpUs[0].name,localStorage.prev_cpumanufacturer==n.cpUs[0].manufacturer?delete n.cpUs[0].manufacturer:localStorage.prev_cpumanufacturer=n.cpUs[0].manufacturer,localStorage.prev_cpumodel==n.cpUs[0].model?delete n.cpUs[0].model:localStorage.prev_cpumodel=n.cpUs[0].model,localStorage.prev_speed==n.cpUs[0].speed?delete n.cpUs[0].speed:localStorage.prev_speed=n.cpUs[0].speed,localStorage.prev_cputype==n.cpUs[0].type?delete n.cpUs[0].type:localStorage.prev_cputype=n.cpUs[0].type,0===Object.keys(n.cpUs[0]).length?delete n.cpUs:t+=JSON.stringify(n.cpUs),localStorage.prev_connection==n.networkAdapters[0].connection?delete n.networkAdapters[0].connection:localStorage.prev_connection=n.networkAdapters[0].connection,localStorage.prev_NetworkType==n.networkAdapters[0].type?delete n.networkAdapters[0].type:localStorage.prev_NetworkType=n.networkAdapters[0].type,localStorage.prev_linkSpeed==n.networkAdapters[0].linkSpeed?delete n.networkAdapters[0].linkSpeed:localStorage.prev_linkSpeed=n.networkAdapters[0].linkSpeed,localStorage.prev_status==n.networkAdapters[0].status?delete n.networkAdapters[0].status:localStorage.prev_status=n.networkAdapters[0].status,null==n.networkAdapters[0].ipv4address||localStorage.prev_ipv4address==n.networkAdapters[0].ipv4address?delete n.networkAdapters[0].ipv4address:localStorage.prev_ipv4Address=n.networkAdapters[0].ipv4address,null==n.networkAdapters[0].ipv6address||localStorage.prev_ipv6address==n.networkAdapters[0].ipv6address?delete n.networkAdapters[0].ipv6address:localStorage.prev_ipv6address=n.networkAdapters[0].ipv6address,0===Object.keys(n.networkAdapters[0]).length?delete n.networkAdapters:t+=JSON.stringify(n.networkAdapters),a=E(JSON.stringify(n.displayAdapters)).then(function(e){localStorage.prev_displayAdaptersDigest==e?delete n.displayAdapters:(localStorage.prev_displayAdaptersDigest=e,t+=JSON.stringify(n.displayAdapters))}),e=E(JSON.stringify(n.disks)).then(function(e){localStorage.prev_disksDigest==e?delete n.disks:(localStorage.prev_disksDigest=e,t+=JSON.stringify(n.disks))}),Promise.all([a,e]).then(function(){E(t).then(function(e){n.checkSum=e,R(n,!0,e).then(o).catch(r)})})):o()}else{let t={accountID:localStorage.accountID,deviceID:localStorage.deviceID,updateRequest:!0,identifier:localStorage.macAddress};E("").then(function(e){t.checkSum=e,R(t,!0,e).then(o).catch(r)})}})}async function E(e){e=(new TextEncoder).encode(e),e=await crypto.subtle.digest("SHA-256",e);const t=Array.from(new Uint8Array(e));return t.map(e=>e.toString(16).padStart(2,"0")).join("")}function R(n,s,i){return new Promise(function(e,t){var a=JSON.stringify(n);O.altdebug("sendHardwareInventoryHTTP: "+a);var o=new XMLHttpRequest;let r=s?"PATCH":"POST";O.altdebug("1026 sendHardwareInventoryHTTP: METHOD: "+r),Q(localStorage.region)||"nsclassroomapi"==localStorage.region?o.open(r,"https://nsclassroomtechnicianapi.azurewebsites.net/api/Inventory/hardware"):o.open(r,"https://technicianapi-"+localStorage.region+".classroom.cloud/api/Inventory/hardware"),o.setRequestHeader("Content-Type","application/json"),o.setRequestHeader("Accept","application/json"),o.send(a),o.onreadystatechange=function(){this.readyState!==o.DONE||200!==this.status&&204!==this.status?(O.altdebug("1052 websockets sendHardwareInventoryHTTP - status: "+this.status),304==this.status&&(O.altdebug("1054 sendHardwareInventoryHTTP status: "+this.status),""!=this.responseText&&O.altdebug("1056 websockets sendHardwareInventoryHTTP - response: "+this.responseText),require(["modules/ciccore"],function(e){O.altdebug("1059 sebsockets - status 304 - updating HW Inventory"),localStorage.hardwareDigestHexPrev=void 0,e.core.updateHardwareInventory()})),0==this.status&&t()):(O.altdebug("1045 sendHardwareInventoryHTTP SUCCESS status: "+this.status),""!=this.responseText&&O.altdebug("1047 websockets sendHardwareInventoryHTTP - response: "+this.responseText),localStorage.hardwareDigestHexPrev=i,e())}})}function L(e){return new Promise(function(r,n){var s,t=e[0];let a={deviceID:localStorage.deviceID,accountID:localStorage.accountID,activity:[]};for(i=0;i<t.internet.length;i++){let e={loginID:localStorage.userName,loggedOnUser:"true"==localStorage.googleAdminAccess&&"true"==localStorage.isManaged&&null!=localStorage.name?localStorage.name:localStorage.userName.split("@")[0],startTime:null!=t.internet[i].starttime?t.internet[i].starttime:null,endTime:null!=t.internet[i].endtime?t.internet[i].endtime:null,uniqueSession:new Date(t.internet[i].starttime).getTime()>parseInt(localStorage.lastSentInternet)&&null!=t.internet[i].endtime,activeTime:t.internet[i].activetime,url:t.internet[i].url,webSiteName:t.internet[i].title,fullURL:t.internet[i].fullURL,status:t.internet[i].status};0!=e.url.indexOf("chrome://")&&0!=e.url.indexOf("chrome-extension://")&&a.activity.push(e)}0<a.activity.length&&chrome.runtime.sendMessage({storeSync:!0,data:{ids:{loginID:a.activity[0].loginID,loggedOnUser:a.activity[0].loggedOnUser}}}),s=a,new Promise(function(a,e){chrome.runtime.sendMessage({getSync:!0,data:["storedTimes","ids"]},function(e){if(e.hasOwnProperty("storedTimes")&&(dayIndex=(new Date).getDay(),allowedHoursRange=localStorage.appAllowedTimes.split(";")[dayIndex],""!=allowedHoursRange&&null!=allowedHoursRange)){for(allowedHoursStart=allowedHoursRange.split("-")[0],allowedHoursEnd=allowedHoursRange.split("-")[1],allowedHoursStartTime=new Date,allowedHoursStartTime.setHours(allowedHoursStart.split(":")[0]),allowedHoursStartTime.setMinutes(allowedHoursStart.split(":")[1]),allowedHoursStartTime.setSeconds(0),allowedHoursStartTime.setMilliseconds(0),allowedHoursEndTime=new Date,allowedHoursEndTime.setHours(allowedHoursEnd.split(":")[0]),allowedHoursEndTime.setMinutes(allowedHoursEnd.split(":")[1]),allowedHoursEndTime.setSeconds(0),allowedHoursEndTime.setMilliseconds(0),i=0;i<s.activity.length;i++){let a=s.activity[i];if(null==a.endTime)if(function(e,t,a){if(new Date(e.startTime).getTime()<t.getTime()||new Date(e.startTime).getTime()>a.getTime())return!0}(a,allowedHoursStartTime,allowedHoursEndTime)){if(X(a,allowedHoursStartTime)){if(F(allowedHoursStartTime,allowedHoursEndTime)){k&&(a.activeTime=0,require(["modules/ciccore"],function(e){a.startTime=e.core.dateToLocaleISOString(new Date(allowedHoursStartTime.getTime()))}));let t=a.fullURL;require(["models/sites"],function(e){e.keyed[t].activeTime=a.activeTime,e.keyed[t].date.created=a.startTime})}C(allowedHoursEndTime)&&J(a,0,allowedHoursEndTime)}}else"true"==localStorage.useAllowedEndTime&&function(t,a){require(["modules/ciccore"],function(e){t.endTime=e.core.dateToLocaleISOString(a),diff=Math.round((new Date(a.getTime())-new Date(t.startTime).getTime())/1e3),t.activeTime=t.activeTime<=diff?t.activeTime:diff})}(a,allowedHoursEndTime);else t=a,o=allowedHoursStartTime,r=allowedHoursEndTime,new Date(t.endTime).getTime()<o.getTime()||new Date(t.startTime).getTime()>r.getTime()?s.activity.splice(i,1):X(a,allowedHoursStartTime)?require(["modules/ciccore"],function(e){a.startTime=e.core.dateToLocaleISOString(new Date(allowedHoursStartTime.getTime())),diff=Math.round((new Date(a.endTime).getTime()-new Date(a.startTime).getTime())/1e3),a.activeTime=a.activeTime<=diff?a.activeTime:diff,J(a,0,allowedHoursEndTime)}):(diff=Math.round((new Date(a.endTime).getTime()-new Date(a.startTime).getTime())/1e3),a.activeTime=a.activeTime<=diff?a.activeTime:diff)}k=!1,localStorage.useAllowedEndTime=!1}var t,o,r;a({webdata:s})})}).then(function(e){var t=new XMLHttpRequest;Q(localStorage.region)||"nsclassroomapi"==localStorage.region?t.open("POST","https://nsclassroomactivitymonitor.azurewebsites.net/api/Activity/web"):t.open("POST","https://activitymonitor-"+localStorage.region+".classroom.cloud/api/Activity/web"),t.setRequestHeader("Content-Type","application/json"),t.setRequestHeader("Accept","application/json");let a=[],o=5;for("true"==localStorage.recordAllWebsiteActivity&&(o=0),i=0;i<e.webdata.activity.length;i++)(e.webdata.activity[i].activeTime>=o||"Blocked"==e.webdata.activity[i].status)&&0!=e.webdata.activity[i].url.indexOf("chrome://")&&a.push(e.webdata.activity[i]);e.webdata.activity=a,json=JSON.stringify(e.webdata),require(["models/sites"],function(t){e.webdata.activity.map(function(e){null!=t.keyed[e.fullURL]&&(t.keyed[e.fullURL].date.created=null!=e.startTime?e.startTime:t.keyed[e.fullURL].date.created,t.keyed[e.fullURL].date.destroyed=null!=e.endTime?e.endTime:t.keyed[e.fullURL].date.destroyed)})}),0!=e.webdata.activity.length&&("true"==localStorage.isWebMonitoringAllowed||"true"==localStorage.allowSendWebMetering)?("true"==localStorage.allowSendWebMetering&&(localStorage.allowSendWebMetering="false"),O.altdebug("1160 websockets - sendInternetMetering data: "+json),t.send(json)):r(),t.onreadystatechange=function(){this.readyState!==t.DONE||200!==this.status&&204!==this.status?(O.altdebug("1170 websockets - sendInternetMetering status: "+this.status),0==this.status&&n()):(O.altdebug("1170 websockets - sendInternetMetering SUCCESS: "+this.status),localStorage.lastSentInternet=(new Date).getTime(),r())}})})}function C(e){return(new Date).getTime()>e.getTime()}function J(t,e,a){(null==t.endTime||new Date(t.endTime).getTime()>new Date(a).getTime())&&require(["modules/ciccore"],function(e){t.endTime=e.core.dateToLocaleISOString(a),diff=Math.round((new Date(t.endTime).getTime()-new Date(t.startTime).getTime())/1e3),t.activeTime=t.activeTime<=diff?t.activeTime:diff})}function j(t,e,a){(null==t.logoutTime||new Date(t.logoutTime).getTime()>new Date(a).getTime())&&require(["modules/ciccore"],function(e){t.logoutTime=e.core.dateToLocaleISOString(a),diff=Math.round((new Date(a.getTime())-new Date(t.loginTime).getTime())/6e4),t.duration=t.duration<=diff?t.duration:diff})}function F(e,t){return(new Date).getTime()>=e.getTime()&&(new Date).getTime()<=t.getTime()}function X(e,t){return new Date(e.startTime).getTime()<t.getTime()}function W(e,t){return new Date(e.loginTime).getTime()<t.getTime()}function Z(s){return new Promise(function(o,r){var n,e=null!=s.logins.archive?s.logins.archive:{};let t={deviceID:localStorage.deviceID,accountID:localStorage.accountID,activity:[]};for(i=0;i<e.length;i++){var a={loginID:localStorage.userName,loggedOnUser:"true"==localStorage.googleAdminAccess&&"true"==localStorage.isManaged&&null!=localStorage.name?localStorage.name:localStorage.userName.split("@")[0],loginTime:null!=e[i].loginTime?e[i].loginTime:null,uniqueSession:new Date(e[i].loginTime).getTime()>parseInt(localStorage.lastSentLogin)&&null!=e[i].logoutTime,logoutTime:null!=e[i].logoutTime?e[i].logoutTime:null,duration:e[i].duration};t.activity.push(a)}0<t.activity.length&&chrome.runtime.sendMessage({storeSync:!0,data:{ids:{loginID:t.activity[0].loginID,loggedOnUser:t.activity[0].loggedOnUser}}}),n=t,new Promise(function(t,e){y.get(["storedTimes","ids"]).then(function(e){if(e.hasOwnProperty("storedTimes")&&(dayIndex=(new Date).getDay(),allowedHoursRange=localStorage.appAllowedTimes.split(";")[dayIndex],""!=allowedHoursRange&&null!=allowedHoursRange))for(allowedHoursStart=allowedHoursRange.split("-")[0],allowedHoursEnd=allowedHoursRange.split("-")[1],allowedHoursStartTime=new Date,allowedHoursStartTime.setHours(allowedHoursStart.split(":")[0]),allowedHoursStartTime.setMinutes(allowedHoursStart.split(":")[1]),allowedHoursStartTime.setSeconds(0),allowedHoursStartTime.setMilliseconds(0),allowedHoursEndTime=new Date,allowedHoursEndTime.setHours(allowedHoursEnd.split(":")[0]),allowedHoursEndTime.setMinutes(allowedHoursEnd.split(":")[1]),allowedHoursEndTime.setSeconds(0),allowedHoursEndTime.setMilliseconds(0),i=0;i<n.activity.length;i++){let t=n.activity[i];null==t.logoutTime?(a=t,o=allowedHoursStartTime,r=allowedHoursEndTime,new Date(a.loginTime).getTime()<o.getTime()||new Date(a.loginTime).getTime()>r.getTime()?W(t,allowedHoursStartTime)&&(F(allowedHoursStartTime,allowedHoursEndTime)&&require(["modules/ciccore"],function(e){t.loginTime=e.core.dateToLocaleISOString(new Date(allowedHoursStartTime.getTime())),t.duration=Math.round(((new Date).getTime()-allowedHoursStartTime.getTime())/6e4)}),C(allowedHoursEndTime)&&j(t,0,allowedHoursEndTime)):F(allowedHoursStartTime,allowedHoursEndTime)||function(t,a){require(["modules/ciccore"],function(e){t.logoutTime=e.core.dateToLocaleISOString(a),diff=Math.round((new Date(a.getTime())-new Date(t.loginTime).getTime())/6e4),t.duration=t.duration<=diff?t.duration:diff})}(t,allowedHoursEndTime)):(o=t,a=allowedHoursStartTime,r=allowedHoursEndTime,new Date(o.logoutTime).getTime()<a.getTime()||new Date(o.loginTime).getTime()>r.getTime()?n.activity.splice(i,1):W(t,allowedHoursStartTime)?require(["modules/ciccore"],function(e){t.logoutTime=e.core.dateToLocaleISOString(new Date(allowedHoursStartTime.getTime())),j(t,0,allowedHoursEndTime)}):j(t,0,allowedHoursEndTime))}var a,o,r;t({loginData:n})})}).then(function(t){var e=JSON.stringify(t.loginData),a=new XMLHttpRequest;Q(localStorage.region)||"nsclassroomapi"==localStorage.region?a.open("POST","https://nsclassroomactivitymonitor.azurewebsites.net/api/Activity/login"):a.open("POST","https://activitymonitor-"+localStorage.region+".classroom.cloud/api/Activity/login"),a.setRequestHeader("Content-Type","application/json"),a.setRequestHeader("Accept","application/json"),0==t.loginData.activity.length?o():(require(["models/login"],function(e){e.logins.archive=t.loginData.activity}),"true"==localStorage.isLoginMonitoringAllowed||"true"==localStorage.allowSendLoginMetering?("true"==localStorage.allowSendLoginMetering&&(localStorage.allowSendLoginMetering="false"),a.send(e)):o()),a.onreadystatechange=function(){this.readyState!==a.DONE||200!==this.status&&204!==this.status?0==this.status&&r():(localStorage.lastSentLogin=(new Date).getTime(),o())}})})}function G(a,o,r,n,i){if(n<i){let e=[];for(p=0;null!=r[n].icons&&p<r[n].icons.length;p++){var l=r[n].icons[p].size,c=r[n].icons[p].url;e.push({size:l,url:c})}let t=0;for(s=0;s<e.length;s++)null!=e[s]&&(t=s);!function(n,s,e,i,l,c){if(l<c){let a=i[l].id;i[l].description,i[l].enabled,i[l].homepageUrl;let o=i[l].name;i[l].shortName;let r=i[l].version;var d=document.createElement("img");null!=e?(d.src=e,d.width="128",d.height="128",d.alt="",d.onload=function(){var e,t=(e=d,(t=document.createElement("canvas")).width=e.width,t.height=e.height,t.getContext("2d").drawImage(e,0,0),dataUrl=t.toDataURL("image/png"),dataUrl.replace(/^data:image\/(png|jpg);base64,/,"")),t={key:a,name:o,installDate:null,version:r,publisher:null,applicationType:3,icon:t};v.software.push(t),B(a,l,n,s,i,c)}):(e={key:a,name:o,installDate:null,version:r,publisher:null,applicationType:3,icon:null},v.software.push(e),B(a,l,n,s,i,c))}}(a,o,0<e.length?e[t].url:null,r,n,i)}else 0!=v.software.length?E(JSON.stringify(v.software)).then(function(e){var r;""!=localStorage.digestSoftwareHex&&0==e.localeCompare(localStorage.digestSoftwareHex)||(v.checkSum=e,r=v,new Promise(function(e,t){var a=JSON.stringify(r);O.altdebug("sendSoftwareInventoryHTTP: "+a);var o=new XMLHttpRequest;Q(localStorage.region)||"nsclassroomapi"==localStorage.region?o.open("POST","https://nsclassroomtechnicianapi.azurewebsites.net/api/Inventory/software"):o.open("POST","https://technicianapi-"+localStorage.region+".classroom.cloud/api/Inventory/software"),o.setRequestHeader("Content-Type","application/json"),o.setRequestHeader("Accept","application/json"),o.send(a),o.onreadystatechange=function(){this.readyState!==o.DONE||200!==this.status&&204!==this.status?0==this.status&&t():(O.altdebug("sendSoftwareInventoryHTTP: SUCCESS"),e())}}).then(a).catch(o))}):a()}function B(e,t,a,o,r,n){var s;"development"!=r[t].installType?(s=new XMLHttpRequest,Q(localStorage.region)||"nsclassroomapi"==localStorage.region?s.open("GET","https://nscfunctions.azurewebsites.net/api/ChromeStore/"+e,!0):s.open("GET","https://functions-"+localStorage.region+".classroom.cloud/api/ChromeStore/"+e,!0),s.setRequestHeader("Content-Type","application/json"),s.setRequestHeader("Accept","application/json"),s.onload=function(e){200==this.status&&(v.software[t].publisher=JSON.parse(this.response).publisher,G(a,o,r,t+1,n))},s.onerror=function(e){},s.send()):(s=t+1,v.software[t].publisher="",G(a,o,r,s,n))}function V(e){function t(e){return((e=Math.floor(Math.abs(e)))<10?"0":"")+e}var a=-e.getTimezoneOffset(),o=0<=a?"+":"-";return e.getFullYear()+"-"+t(e.getMonth()+1)+"-"+t(e.getDate())+"T"+t(e.getHours())+":"+t(e.getMinutes())+":"+t(e.getSeconds())+o+t(a/60)+":"+t(a%60)}function Q(e){return new RegExp("^(https?:\\/\\/)?((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|((\\d{1,3}\\.){3}\\d{1,3}))(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*(\\?[;&a-z\\d%_.~+=-]*)?(\\#[-a-z\\d_]*)?$","i").test(e)}function $(){setTimeout(function(){S.notify()},3e4)}function Y(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})}return{updatewebdatatimer:function(){var e=(null!=r.config.frequency?r.config:JSON.parse(localStorage.activityMonitorConfigData).activityMonitor).frequency;window.clearInterval(D),D=window.setInterval(function(){N().then(L).then(r.clearSites)},1e3*e),N().then(L).then(r.clearSites)},updateLoginTimer:function(){var e=(null!=c.config.frequency?r.config:JSON.parse(localStorage.activityMonitorConfigData).activityMonitor).frequency;window.clearInterval(T),T=window.setInterval(function(){x().then(Z).then(c.clearLogins)},1e3*e),x().then(Z).then(c.clearLogins)},internet:N,login:x,esafety:U,queued:M,queuedVid:M,hardware:function(e){e?a.hardware(e).then(function(e){return{hardware:e}}).then(function(e){P(e.hardware)}):a.hardware(e).then(function(a){return new Promise(function(e,t){e({hardware:a})})}).then(function(e){e.hardware&&P(e.hardware)})},software:function(){o.software().then(function(e){return{software:e}}).then(function(e){var a;a=e.software,new Promise(function(e,t){v={accountID:localStorage.accountID,deviceID:localStorage.deviceID,updateRequest:!0,software:[]},G(e,t,a,0,a.length)})})},sendInternetPostLogin:function(r){return new Promise(function(e,t){let a={deviceID:localStorage.deviceID,accountID:localStorage.accountID,activity:[]};for(s=0;s<r.length;s++){let e={loginID:r[s].loginID,loggedOnUser:r[s].loggedOnUser,startTime:r[s].starttime,endTime:r[s].endtime,uniqueSession:!1,activeTime:r[s].activetime,url:r[s].url,fullURL:r[s].fullURL};5<=r[s].activetime&&0!=e.url.indexOf("chrome://")&&a.activity.push(e)}var o=new XMLHttpRequest;Q(localStorage.region)||"nsclassroomapi"==localStorage.region?o.open("POST","https://nsclassroomactivitymonitor.azurewebsites.net/api/Activity/web"):o.open("POST","https://activitymonitor-"+localStorage.region+".classroom.cloud/api/Activity/web"),o.setRequestHeader("Content-Type","application/json"),o.setRequestHeader("Accept","application/json"),json=JSON.stringify(a),0!=a.activity.length&&"true"==localStorage.isWebMonitoringAllowed?o.send(json):e(),o.onreadystatechange=function(){this.readyState!==o.DONE||200!==this.status&&204!==this.status?0==this.status&&t():(localStorage.lastSentInternet=(new Date).getTime(),e())}})},sendLoginMeteringOnRestart:function(l){return new Promise(function(e,t){var a=null!=l.archive?l.archive:{};let o={deviceID:localStorage.deviceID,accountID:localStorage.accountID,activity:[]};for(i=0;i<a.length;i++){var r=Math.round((new Date(a[i].logoutTime).getTime()-new Date(a[i].loginTime).getTime())/6e4),r={loginID:a[i].loginID,loggedOnUser:a[i].loggedOnUser,loginTime:a[i].loginTime,uniqueSession:!1,logoutTime:a[i].logoutTime,duration:1<r?r:1};o.activity.push(r)}var n=JSON.stringify(o),s=new XMLHttpRequest;Q(localStorage.region)||"nsclassroomapi"==localStorage.region?s.open("POST","https://nsclassroomactivitymonitor.azurewebsites.net/api/Activity/login"):s.open("POST","https://activitymonitor-"+localStorage.region+".classroom.cloud/api/Activity/login"),s.setRequestHeader("Content-Type","application/json"),s.setRequestHeader("Accept","application/json"),0!=o.activity.length&&"true"==localStorage.isLoginMonitoringAllowed?s.send(n):e(),s.onreadystatechange=function(){this.readyState!==s.DONE||200!==this.status&&204!==this.status?0==this.status&&t():(localStorage.lastSentLogin=(new Date).getTime(),e())}})},sendLoginsOnRestart:function(){x().then(Z).then(c.clearLogins)},sendInternetOnRestart:function(){N().then(L).then(r.clearSites)},isItCurrentlyInAllowedHours:F,sendInternet:function(){k=!0,N().then(L).then(r.clearSites)},sendLogin:function(){x().then(Z).then(c.clearLogins)}}});