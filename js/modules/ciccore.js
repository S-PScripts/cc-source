define(["comms.nc.protocol","pubsub","comms.websocket","utf8","modules/extension","modules/translate","modules/image","background/messageQueue","models/useridentity","background/CLIENT","chatlib","Transmit","student","models/TabData","models/Tab","yEncRev"],function(r,s,o,c,l,g,e,n,t,a,u,d,m,S,h,p){var f,T,I={badge:{updateBadgeColour:A,updateBadge:N},status:k,registration:R,deviceDetailsChange:function(a){N(a),a&&(a.batteryCharging||a.batteryLevel)&&chrome.runtime.sendMessage({getLocal:!0,data:["batteryCharging","batteryLevel"]},function(e){var t,n=a.batteryCharging&&a.batteryCharging.newValue?"Yes"==a.batteryCharging.newValue?1:0:"Yes"==e.batteryCharging?1:0,e=a.batteryLevel&&a.batteryLevel.newValue?a.batteryLevel.newValue:e.batteryLevel.split("%")[0],o=String.fromCharCode(183,0,1,parseInt(n),parseInt(e));for(t in m.Connections)null!=t&&l.senddata(t,o)});a&&a.networkType&&chrome.runtime.sendMessage({getLocal:!0,data:["networkType"]},function(e){if("ethernet"!=e.networkType){var t=String.fromCharCode(184,0,1,0,"0",100,1,e.networkType+"\0",0);for(n in m.Connections)null!=n&&l.senddata(n,t)}else{var n,o=String.fromCharCode(184,0,1,0,"0",0,1,e.networkType+"\0",0);for(n in m.Connections)null!=n&&l.senddata(n,o)}});{var e;a&&(a.serialNumber||a.location||a.deviceAssetId||a.roomSpec||a.unlocktimeout)&&(a.unlocktimeout&&(localStorage.unlocktimeout=a.unlocktimeout.newValue),e={accountID:localStorage.accountID,siteID:localStorage.siteID,identifier:localStorage.macAddress},a.serialNumber&&(e.name=a.serialNumber.newValue,localStorage.serialNumber=a.serialNumber.newValue),a.location&&(e.location=a.location.newValue,localStorage.location=a.location.newValue),a.deviceAssetId&&(e.assetTag=a.deviceAssetId.newValue,localStorage.deviceAssetId=a.deviceAssetId.newValue),R(e),B(!0),_())}},branding:function(){$.getJSON("oem_branding.json",function(e){$.each(e,function(e,t){"customBackgroundColour"===e&&(localStorage.customBackgroundColour=t),"copyright"===e&&(t=(t=t.split(" "))[0]+" "+(new Date).getFullYear()+" "+t[2]+" "+t[3],localStorage.copyright=t)})})},tooltip:function(){setInterval(function(){localStorage.setItem("chatBtnTxt",g("CHAT")),localStorage.setItem("joinClassBtnTxt",g("JOIN")),localStorage.setItem("cancelJoinClassBtnTxt",g("CANCEL")),localStorage.setItem("helpRequestBtnTxt",g("HELP_REQUEST")),localStorage.setItem("classCodeLabel",g("CLASSCODE")),localStorage.setItem("validClassCodeText",g("CLASSCONNECTIONSTATUS")),localStorage.setItem("invalidClassCodeText",g("CLASSCONNECTIONINVALID")),localStorage.setItem("chatBtnTxtToolTip",g("CHATTOOLTIP")),localStorage.setItem("helpBtnTxtToolTip",g("HELPTOOLTIP")),localStorage.setItem("internetBtnTextToolTip",g("INTERNETOOLTIP")),localStorage.setItem("objectivesBtnTextToolTip",g("OBJECTIVESTOOLTIP")),localStorage.setItem("reportConcernBtnTextToolTip",g("REPORT_A_CONCERN")),localStorage.setItem("chatBtnTxtToolTipDesc",g("CHATBTNTOOLTIPDESC")),localStorage.setItem("helpBtnTxtToolTipDesc",g("HELBBTNTOOLTIPDESC")),localStorage.setItem("internetBtnTextToolTipDesc",g("INTERNETBTNTOOLTIPDESC")),localStorage.setItem("objectivesBtnTextToolTipDesc",g("OBJECTIVESBTNTOOLTIPDESC")),localStorage.setItem("reportConcernBtnTextToolTipDesc",g("CONCERN_BUTTON_TOOLTIP_DESC")),localStorage.setItem("internetBtnNoRestrictions",g("NORESTRICTIONS")),localStorage.setItem("internetBtnApproveOnly",g("APPROVEONLY")),localStorage.setItem("internetBtnBlockRestricted",g("BLOCKRESTRICTED")),localStorage.setItem("internetBtnBlockAll",g("BLOCKALL")),localStorage.setItem("safeguardingResourcesBtnTextToolTip",g("SAFEGURADINGTOOLTIP")),localStorage.setItem("safeguardingResourcesBtnTextToolTipDesc",g("SAFEGURADINGTOOLTIPDESC")),localStorage.setItem("safeguardingResourcesTableNameHeader",g("SAFEGURADING_TABLE_NAME")),localStorage.setItem("safeguardingResourcesTablePhoneHeader",g("SAFEGURADING_TABLE_PHONE")),localStorage.setItem("safeguardingResourcesTableDescriptionHeader",g("SAFEGURADING_TABLE_DESCRIPTION")),localStorage.setItem("concerncannotsend",g("SORRY_TECHNICAL_ISSUE")),localStorage.setItem("concernsentconfirmation",g("WE_GOT_YOUR_CONCERN")),localStorage.setItem("concerntryagainlater",g("PLEASE_TRY_AGAIN_LATER")),chrome.runtime.sendMessage({getLocal:!0,data:["connectionState","allowAvailableStatusAction"]},function(e){var t=localStorage.connectionState,n=localStorage.allowAvailableStatusAction;"disconnected"==e.connectionState?"18"==localStorage.cloudState?chrome.runtime.sendMessage({updateTitle:!0,title:g("UNLICENSED")}):chrome.runtime.sendMessage({updateTitle:!0,title:g("NOT_CONNECTED")}):"connected_NCS"==t?"18"==localStorage.cloudState?chrome.runtime.sendMessage({updateTitle:!0,title:g("UNLICENSED")}):"20"==localStorage.cloudState?chrome.runtime.sendMessage({updateTitle:!0,title:g("UNAPPROVED_NETWORK")}):"21"==localStorage.cloudState?chrome.runtime.sendMessage({updateTitle:!0,title:g("OUT_OF_HOURS")}):"1"==localStorage.cloudState&&("true"==n&&chrome.runtime.sendMessage({updateTitle:!0,title:g("AVAILABLE")}),k("connected_NCS")):"connected_TUTOR"==e.connectionState&&("false"==localStorage.isWatching?"true"==localStorage.isConnectedTextSet?chrome.runtime.sendMessage({updateTitle:!0,title:localStorage.connectedtext}):chrome.runtime.sendMessage({updateTitle:!0,title:g("IN_CLASS")}):"true"==localStorage.isViewedTextSet?chrome.runtime.sendMessage({updateTitle:!0,title:localStorage.viewedtext}):chrome.runtime.sendMessage({updateTitle:!0,title:g("IN_CLASS")}))});var e=localStorage.getItem("internetBtnTextToolTip"),t=localStorage.getItem("internetBtnNoRestrictions"),n=localStorage.getItem("internetBtnApproveOnly"),o=localStorage.getItem("internetBtnBlockRestricted"),a=localStorage.getItem("internetBtnBlockAll");localStorage.getItem("internetBtnTextToolTipDesc");"1"==localStorage.internetStatus||null==localStorage.internetStatus?(localStorage.setItem("internetBtnTextToolTip",e),localStorage.setItem("internetBtnTextToolTipDesc",t),localStorage.setItem("OpenBrowser",1)):"2"==localStorage.internetStatus?(localStorage.setItem("internetBtnTextToolTip",e),localStorage.setItem("internetBtnTextToolTipDesc",o),localStorage.setItem("OpenBrowser",0)):"3"==localStorage.internetStatus?(localStorage.setItem("internetBtnTextToolTip",e),localStorage.setItem("internetBtnTextToolTipDesc",n),localStorage.setItem("OpenBrowser",2)):(localStorage.setItem("internetBtnTextToolTip",e),localStorage.setItem("internetBtnTextToolTipDesc",a),localStorage.setItem("OpenBrowser",0))},1e3)},rewards:function(){chrome.runtime.sendMessage({getSync:!0,data:["rewardCount"]},function(e){localStorage.rewardCount=e.rewardCount})},userack:{displayUserAcknowledgement:function(e){var t=e.substring(16,e.length).split(z);t[8],sessionStorage.room;e=t[4],e=NSLibrary.Translate("PLACEHOLDER_WISHES_TO_CONNECT",e);localStorage.setItem("teacherName",e),localStorage.setItem("connectData",t),x=screen.width/2-250,y=screen.height/2-190,setTimeout(function(){"true"!=localStorage.getItem("isWatch")&&chrome.runtime.sendMessage({createWindow:!0,windowData:{url:"connectionAcknowledgementDialog.html",focused:!0,type:"popup",width:500,height:380,left:parseInt(x),top:parseInt(y)}},function(e){localStorage.setItem("connectionAcknowledgementDialogID",e.id)})},600)},completeConnectionDefaultNoAcknowledgement:function(e,t){var n,o=t.substring(16,t.length).split(z),a=o[8];sessionStorage.room;if(""!==a&&"*"!==a){if(10<o.length)a=c.ForceDecode(o[10]);else if(a)for(i=0;i<a.length;i++)if(127<a.charCodeAt(i))return s.publish("connect",{cid:e,d:t}),void(localStorage.connectedToTutor=!0);"true"==localStorage.joinClassInitiated?a!=localStorage.inputtedClassCode?(n=String.fromCharCode(r.REJECT,0,23,0,0),l.senddata(e,n)):(s.publish("connect",{cid:e,d:t}),localStorage.connectedToTutor=!0):a&&a.toLowerCase()!==localStorage.roomspec.toLowerCase()?(n=String.fromCharCode(r.REJECT,0,23,0,0),l.senddata(e,n)):(s.publish("connect",{cid:e,d:t}),localStorage.connectedToTutor=!0)}else s.publish("connect",{cid:e,d:t}),localStorage.connectedToTutor=!0}},message:{showMessageDialog:function(e,t){localStorage.reopened=!1,debug("in MESSAGE");var n=e,o=n.indexOf(z,6),a=n.indexOf(z,22),r=n.indexOf("|",a+1),e=n.indexOf(z,r+1);o=n.substring(6,o),zx=e+2,zxn=n.indexOf(z,zx),0<=zxn&&(o=c.Decode(n.substring(zx,zxn),t));e=c.Decode(n.substring(22,a),t);t=n.substring(a+1,r),o=NSLibrary.Translate("MESSAGE_FROM_PLACEHOLDER",o),n=new Date;a=n.toLocaleString("default",{month:"long"});r=n.getDate()+" "+a+" "+n.getFullYear(),a=n.toLocaleTimeString(),r=a.split(":")[0]+":"+a.split(":")[1]+" "+r;let i=O(e);r=o+"\n\n"+r+"\n\n"+E(i.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"));localStorage.setItem("messageText",r),localStorage.setItem("messageTimeout",""!=t?parseInt(t):t),localStorage.setItem("fromMessageEX","false"),localStorage.setItem("receivedDateTime",G(n));x=screen.width/2-325,y=screen.height/2-200,chrome.runtime.sendMessage({createWindow:!0,windowData:{url:"cicmessagebox.html",focused:!0,type:"popup",width:780,height:400,left:parseInt(x),top:parseInt(y)}},function(e){localStorage.setItem("messageDialogWinID",e.id)})},showMessageDialogForRandomSelect:function(e){debug("in MESSAGEEX");let t=0;var n=e,o="";t=10;for(;0!=n.charCodeAt(t);)o+=n.charAt(t),t+=1;localStorage.reopened=!1;var o=NSLibrary.Translate("MESSAGE_FROM_PLACEHOLDER",o),a=n.charCodeAt(t+5),r=new Date;var i=r.toLocaleString("default",{month:"long"});e=r.getDate()+" "+i+" "+r.getFullYear(),i=r.toLocaleTimeString(),i=i.split(":")[0]+":"+i.split(":")[1],e=o+"\n\n"+i+" "+e+"\n\n"+NSLibrary.Translate("RANDOM_SELECT_MSG");localStorage.setItem("messageText",e),localStorage.setItem("messageTimeout",parseInt(a)),localStorage.setItem("fromMessageEX","true"),localStorage.setItem("receivedDateTime",G(r));x=screen.width/2-325,y=screen.height/2-200,setTimeout(function(){chrome.runtime.sendMessage({createWindow:!0,windowData:{url:"cicmessagebox.html",focused:!0,type:"popup",width:650,height:400,left:parseInt(x),top:parseInt(y)}},function(e){localStorage.setItem("randomSelectDialogWinID",e.id)})},3e3)},showInternetStatusDialog:function(e){let t="",n;switch(e){case 1:t=localStorage.getItem("internetBtnNoRestrictions"),n=0;break;case 2:t=localStorage.getItem("internetBtnBlockRestricted"),n=1;break;case 3:t=localStorage.getItem("internetBtnApproveOnly"),n=0;break;case 4:t=localStorage.getItem("internetBtnBlockAll"),n=2}localStorage.setItem("internetStatusMessage",t),localStorage.setItem("iconType",n);e=120;e=t.length<=69?120:t.length<=140?140:t.length<=210?160:180;x=screen.width-300,y=screen.height-e/2,chrome.runtime.sendMessage({createWindow:!0,windowData:{url:"cicinternetstatusdialog.html",focused:!0,type:"popup",width:600,height:e,left:parseInt(x),top:parseInt(y)}},function(e){localStorage.setItem("messageInternetStatusDialogWinID",e.id)})}},batteryStatus:function(){navigator.getBattery().then(function(e){function t(){e.charging?chrome.runtime.sendMessage({updateBatteryCharging:!0,batteryCharging:"Yes"}):chrome.runtime.sendMessage({updateBatteryCharging:!0,batteryCharging:"No"})}function n(){chrome.runtime.sendMessage({updateBatteryLevel:!0,batteryLevel:100*e.level+"%"})}t(),n(),e.addEventListener("chargingchange",function(){t()}),e.addEventListener("levelchange",function(){n()})})},networkType:function(){var e=navigator.connection,t=e.type,n=(e.effectiveType,e.rtt,e.downlinkMax,e.downlink);function o(){t=e.type,chrome.runtime.sendMessage({updateNetworkType:!0,networkType:"wifi"==t?"Wireless":t})}localStorage.setItem("downlink",n),localStorage.setItem("networkTypeInv","wifi"==t?"Wireless":t),o(),e.addEventListener("change",o)},getTimezone:function(){var e=(new Date).getTimezoneOffset();chrome.runtime.sendMessage({storeLocal:!0,data:{timezone:e}})},timezoneChange:function(e){e&&e.timezone&&require(["modules/cicregistration"],function(e){e.cic.config()})},persistentScreenshots:function(){"undefined"!=localStorage.persistentThumbnailTimer&&window.clearInterval(parseInt(localStorage.persistentThumbnailTimer));localStorage.persistentThumbnailTimer=setInterval(()=>{e.takeScreenshot(!1)},1e3)},checkConnectionActivity:function(){null!=localStorage.checkConnectionActivityInterval&&clearInterval(parseInt(localStorage.checkConnectionActivityInterval));localStorage.checkConnectionActivityInterval=setInterval(()=>{var e=null!=localStorage.reconnectTimeout&&""!=localStorage.reconnectTimeout?parseInt(localStorage.reconnectTimeout):10;(new Date).getTime()-parseInt(localStorage.lastConnected)>60*e*1e3&&require(["student"],function(e){"false"==localStorage.loginInitiated&&(e.Connections={},e.ActiveConnection={},localStorage.loginInitiated=!1)})},6e4)},processFrames:function(e){let t=0,n=0,o=0,a=0,r=!1,i=15,s=!1;setInterval(function(){if(i=parseInt(localStorage.recordinglength),null!=e.hiDPICanvas)if("true"==localStorage.phraseTriggeredWithVideoSet&&(localStorage.phraseTriggeredWithVideoSet=!1,0==n?s=1==localStorage.phraseSource?(n=C.length-10,!0):(n=C.length,!1):t=1==s?C.length-10:C.length),1==b&&D?C.push(D):C.push(e.hiDPICanvas.toDataURL("image/webp",.8)),0!=n){if(C.length>=n+i){let e=JSON.parse(localStorage.phraseMatchIDs);w=e.slice(),e.length=0,localStorage.phraseMatchIDs=JSON.stringify(e),0!=t?(setTimeout(function(){o<i?F(C.slice(0,C.length),w):F(C.slice(o-i,C.length),w),r=!1},1e3*(a-o)),o=n,a=t,n=0,t=0,r=!0):(r=(C.length>2*i?0!=w.length&&F(C.slice(C.length-2*i,C.length),w):0!=w.length&&F(C,w),!1),n=0,t=0)}}else setTimeout(function(){75<C.length&&0==n&&0==r&&C.splice(0,C.length-50)},5e3)},1e3)},isTriggerable:function(e,t,n,o){if(n.includes(".netsupportdna.")||n.includes("dnaauthentication-uksouth.")||n.includes("dnaesafety-uksouth.")||n.includes("dnafunctions-uksouth.")||n.includes("dnarestapi-uksouth.")||n.includes("netsupportdna.")||n.includes(".classroom.cloud")||n.includes("classroom.cloud")||n.includes("nsclassroom.azurewebsites.net")||n.includes("nsclassroomtutor.azurewebsites.net"))return!1;if(1==function(e){return 0==e.map(function(e){if(null!=e&&null!=e.detail[1])return{confidence:e.confidence,matchedPhrase:e.text,category:e.detail[0],priority:e.detail[1]}}).reduce(function(e,t){return Math.max(e,null==t?0:t.priority)},0)}(t))return!1;if("true"==localStorage.excludefromphrasemonitoring){var t=localStorage.safeguardingresources,a=JSON.parse(t);const c=new URL("",n);for(i=0;i<a.length;i++)if(""!==a[i]&&"undefined"!=a[i]){const l=new URL("",a[i].Url);if(c.host.replace("www.","")==l.host.replace("www.",""))return!1}}let r="undefined"!=localStorage.excludedwebsites?localStorage.excludedwebsites.split(";"):"";if(""!=r)for(i=0;i<r.length;i++){var s=new URL("",n);if("undefined"!=r[i]){let e="";if(e="http://"==r[i].substring(0,7)||"https://"==r[i].substring(0,8)?new URL("",r[i]):new URL("","https://"+r[i]),s.host==e.host)return!1}}if(1==o.cic.isIpInvalid(localStorage.ipaddress,localStorage.monitoredEsafetyIPs,"onlinesafety"))return!1;return!!(parseInt(localStorage.phraseSources)&e)},updateBrowserActionStatus:function(e,t){1==e&&"true"==localStorage.isConnectedTextSet?V(1e3):2==e?1==t&&"true"==localStorage.isViewedTextSet?V(2e3):0==t&&"true"==localStorage.isConnectedTextSet?V(1e3):q():0==e&&q()},updateHardwareInventory:B,updateSoftwareInventory:_,unMuteSound:H,muteUnMuteSound:function(e){1==e?(chrome.runtime.sendMessage({storeLocal:!0,data:{muteSound:!0}}),chrome.runtime.sendMessage({queryTabs:!0,tabData:{}},function(e){for(var t=0;t<e.length;++t)chrome.runtime.sendMessage({tabsUpdate:!0,tabID:e[t].id,tabData:{muted:!0}})})):(chrome.runtime.sendMessage({storeLocal:!0,data:{muteSound:!1}}),chrome.runtime.sendMessage({queryTabs:!0,tabData:{}},function(e){for(var t=0;t<e.length;++t)chrome.runtime.sendMessage({tabsUpdate:!0,tabID:e[t].id,tabData:{muted:!1}})}))},applyOfflineSettingsTimeout:function(){localStorage.offlineTimedOut=!1,require(["background/CLIENT","modules/ciccore"],function(t,n){localStorage.unlockTimeout=setTimeout(function(){localStorage.offlineLock=!1,chrome.runtime.sendMessage({getLocal:!0,data:["connectionState"]},function(e){localStorage.offlineTimedOut=!0,"connected_TUTOR"==e.connectionState||(t.Lock.unlockClient(),n.core.unMuteSound(),localStorage.offlineTimedOut=!0,localStorage.offlineConnection=void 0)})},1e3*parseInt(localStorage.unlocktimeout))})},sendHelpRequest:W,progressBarChange:function(e){e.updateProgressBarWidth&&chrome.runtime.sendMessage({updateBar:!0,progressWidth:e.updateProgressBarWidth.newValue})},startTimeStampTimer:function(){var e=(new Date).setMilliseconds(0);chrome.runtime.sendMessage({storeSync:!0,data:{storedTimes:{timestamp:e,inHoursEndTime:localStorage.inHoursEndTime}}},function(){window.clearInterval(void 0);setInterval(function(){var e=(new Date).setMilliseconds(0);localStorage.timestampDate=e,chrome.runtime.sendMessage({storeSync:!0,data:{storedTimes:{timestamp:e,inHoursEndTime:localStorage.inHoursEndTime}}})},1e4)})},idleStateChange:function(e){"locked"==e&&(require(["models/login"],function(e){e.registerLogout()}),localStorage.prevState="locked");"active"==e&&"locked"==localStorage.prevState&&(require(["modules/cicregistration"],function(e){e.cic.config().then(U)}),localStorage.prevState="active")},showBroadcastMessage:function(e){localStorage.reopened=!1,debug("in MESSAGE");var t=e.split("\n"),n=p.decode(t[3].split("=")[1]),o=n.indexOf("|"),a=t[1].split("=")[1],r=n.indexOf(z,20),i=n.substring(18,r),e=n.substring(r+1,o),t=n.substring(o+1,n.indexOf(z,o)),r=new Date;n=r.toLocaleString("default",{month:"long"});o=r.getDate()+" "+n+" "+r.getFullYear(),n=r.toLocaleTimeString(),o=n.split(":")[0]+":"+n.split(":")[1]+" "+o,a=NSLibrary.Translate("MESSAGE_FROM_PLACEHOLDER",a);let s=O(i);o=t+"\n\n"+a+"\n\n"+o+"\n\n"+E(s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"));localStorage.setItem("messageText",o),localStorage.setItem("messageTimeout",""!=e?parseInt(e):e),localStorage.setItem("fromMessageEX","false"),localStorage.setItem("receivedDateTime",G(r));x=screen.width/2-325,y=screen.height/2-200,chrome.runtime.sendMessage({createWindow:!0,windowData:{url:"cicmessagebox.html",focused:!0,type:"popup",width:650,height:400,left:parseInt(x),top:parseInt(y)}},function(e){localStorage.setItem("messageDialogWinID",e.id)})},showUserAcceptancePolicy:function a(e,t){localStorage.reopened=!1;x=screen.width/2-450;y=screen.height/2-275;chrome.runtime.sendMessage({createWindow:!0,windowData:{url:"cicusagepolicydialog.html",focused:!0,type:"popup",width:800,height:550,left:parseInt(x),top:parseInt(y)}},function(e){localStorage.setItem("messageDialogWinID",e.id)});L&&clearInterval(L);chrome.runtime.onMessage.addListener(function(e,t,n){if(1==e.windowsGetAllForUAPResponse){for(var o in P=0,e.winData)if(e.winData[o].id===parseInt(localStorage.messageDialogWinID)){P+=1;break}"true"==localStorage.uapsSent?(localStorage.uapsSent=!1,clearInterval(L)):0==P&&chrome.runtime.sendMessage({queryTabs:!0,tabData:{url:chrome.runtime.getURL("cicusagepolicydialog.html")}},function(e){0==e.length&&a()})}return!0});L=setInterval(function(){chrome.runtime.sendMessage({queryTabs:!0,tabData:{url:chrome.runtime.getURL("cicusagepolicydialog.html")}},function(e){0==e.length&&"false"==localStorage.uapClicked?a():"true"==localStorage.uapClicked&&clearInterval(L)})},4e3)},initiateBrowserActionStatus:function(){"undefined"!=localStorage.initiateBrowserActionStatusInterval&&window.clearInterval(parseInt(localStorage.initiateBrowserActionStatusInterval));localStorage.initiateBrowserActionStatusInterval=setInterval(function(){0!=Object.keys(m.Connections).length?(localStorage.connectionState="connected_TUTOR",chrome.runtime.sendMessage({storeLocal:!0,data:{connectionState:"connected_TUTOR"}})):chrome.runtime.sendMessage({getConnectionState:!0},function(e){"connected_NCS"==e.connectionState&&(chrome.runtime.sendMessage({storeLocal:!0,data:{connectionState:"connected_NCS"}}),localStorage.connectionState="connected_NCS")})},2e3)},dateToLocaleISOString:G},C=[],w=[],v=!1;let D,b;chrome.runtime.onMessage.addListener(function(e,t,n){1==e.studentEndChat&&u.studentEndChat(e.instance,t.tab.id)}),chrome.runtime.onMessage.addListener(function(e,t,n){1==e.avoidDisconnect&&(e=G(new Date),o.instance&&o.instance.websocket&&1===o.instance.websocket.readyState&&o.instance.POLL(e))}),chrome.runtime.onMessage.addListener(function(e,t,n){if(1==e.messageForTabID)return localStorage.chatTabIDRefresh=t.tab.id,n({}),!0}),chrome.runtime.onMessage.addListener(function(e,t,n){if(1==e.getConfig)return require(["modules/cicregistration"],function(e){e.cic.config(),n()}),!0}),chrome.runtime.onMessage.addListener(function(e,t,n){1==e.sendMessage&&u.sendMessage(e.instance,e.messageText)}),chrome.runtime.onMessage.addListener(function(e,t,n){1==e.setTarget&&u.setTarget(e.instance,e.element)}),chrome.runtime.onMessage.addListener((e,t,n)=>{1==e.updateIsDesktopCaptureOpen&&(1==e.result?localStorage.isDesktopCaptureOpen=!0:localStorage.isDesktopCaptureOpen=!1)}),chrome.runtime.onMessage.addListener(function(e,t,n){if(1==e.startChat){let t=JSON.parse(localStorage.connection);void 0!==t.cid&&require(["modules/extension"],function(e){e.senddata(t.cid,String.fromCharCode(16,0))})}}),chrome.runtime.onMessage.addListener(function(e,t,n){return 1==e.sendDesktopImageDataURLForCicore&&(D=e.desktopImageDataURL),!0});var L,M=new Map([[/:-?D|:grin:/gi,"üòÄ"],[/:-?\)|:smile:/gi,"üôÇ"],[/:-?\(|:sad:/gi,"üòü"],[/:oops:/gi,"üò≥"],[/:-?o|:eek:/gi,"üòÆ"],[/:shock:/gi,"üòß"],[/:\?:/gi,"‚ùì"],[/:\?\?\?:|:-?\?/gi,"ü§®"],[/8-?\)|:cool:/gi,"üòé"],[/:lol:/gi,"üòÇ"],[/:-?x|:mad:|:angry:|:@/gi,"üò†"],[/:-?P|:razz:/gi,"üòù"],[/:cry:/gi,"üò≠"],[/:evil:|:gavin:/gi,"üëø"],[/:twisted:/gi,"üòà"],[/:roll:/gi,"üôÑ"],[/;-?\)|:wink:/gi,"üòâ"],[/:!:/gi,"‚ùó"],[/:idea:/gi,"üí°"],[/:arrow:/gi,"‚û°"],[/:-?\||:neutral:/gi,"üòê"]]);function E(e){return e.replace(/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi,function(e){return'<a href="'+e+'">'+e+"</a>"})}function O(e){let n=e;return M.forEach(function(e,t){n=n.replace(t,e)}),n}function A(e){"cloudstate"===e?k("settingsenableddisconnection"):"connecting"===e?(localStorage.setItem("canEnableHelpRequestChatIfSet","false"),localStorage.setItem("deviceStatus","Connecting"),18!=localStorage.cloudState&&k("disconnected")):"connected_NCS"===e?(localStorage.setItem("canEnableHelpRequestChatIfSet","false"),localStorage.setItem("deviceStatus","Connected to NCS"),k("connected_NCS")):"connected_TUTOR"===e?(localStorage.setItem("canEnableHelpRequestChatIfSet","true"),localStorage.setItem("deviceStatus","Connected to Tutor"),k("connected_TUTOR")):"disconnected"===e&&(localStorage.setItem("canEnableHelpRequestChatIfSet","false"),localStorage.setItem("deviceStatus","Disconnected"),k("disconnected"))}function k(e){"connected_TUTOR"===e?chrome.runtime.sendMessage({setIcon:!0,iconPath:{16:"images/CIC16Connected.png",32:"images/CIC32Connected.png",48:"images/CIC48Connected.png",128:"images/CIC128Connected.png"}}):"connected_NCS"===e?chrome.runtime.sendMessage({setIcon:!0,iconPath:{16:"images/CIC16.png",32:"images/CIC32.png",48:"images/CIC48.png",128:"images/CIC128.png"}}):"disconnected"===e?chrome.runtime.sendMessage({setIcon:!0,iconPath:{16:"images/CIC16Disconnected.png",32:"images/CIC32Disconnected.png",48:"images/CIC48Disconnected.png",128:"images/CIC128Disconnected.png"}}):"settingsenableddisconnection"===e&&chrome.runtime.sendMessage({setIcon:!0,iconPath:{16:"images/CIC16SettingsEnabledDisconnection.png",32:"images/CIC32SettingsEnabledDisconnection.png",48:"images/CIC48SettingsEnabledDisconnection.png",128:"images/CIC128SettingsEnabledDisconnection.png"}})}function R(t){require(["modules/cicregistration"],function(e){e.cic.updateregistrationdetails(void 0,void 0,void 0,t)})}function N(e){e&&e.connectionState&&(e.connectionState.newValue?A(e.connectionState.newValue):A(e.connectionState)),e&&e.cloudState&&(void 0!==o.instance&&o.instance.CLOUD_STATUS(e.cloudState.newValue),"1"!=e.cloudState.newValue&&"18"!=e.cloudState.newValue?A("cloudstate"):"18"==e.cloudState.newValue?A("disconnected"):A("connected_NCS"))}function B(t){"true"==localStorage.inventoryEnabled&&""!=localStorage.roomspec&&require(["background/websocket"],function(e){e.hardware(t)})}function _(){"true"==localStorage.inventoryEnabled&&""!=localStorage.roomspec&&require(["background/websocket"],function(e){e.software()})}function U(){require(["models/login"],function(e){let t=new Date;t.setMilliseconds(0);var n=t.getTime();e.registerLogin(n),localStorage.loginTime=n,localStorage.isCloseCalled=!1})}setInterval(function(){chrome.runtime.sendMessage({getLocal:!0,data:"connectionState"},function(e){"connected_NCS"==e.connectionState&&(H(),localStorage.offlineConnection="undefined",a.Lock&&a.Lock.unlockClient())})},2e3),setInterval(function(){chrome.runtime.sendMessage({isDesktopCaptureOpen:!0})},1e3),function o(){var t=setInterval(function(){chrome.runtime.sendMessage({queryTabs:!0,tabData:{highlighted:!0}},n=>{if(1<n.length){let e=0;clearInterval(t),n.forEach(function(t){-1==t.url.indexOf("chrome://")&&require(["models/sites"],function(e){e.keyed[t.url]&&null==e.keyed[t.url].date.destroyed?e.keyed[t.url].activeTime=e.keyed[t.url].activeTime+1:e.keyed[t.url]}),e==n.length-1&&o(),e+=1})}else n[0]&&-1==n[0].url.indexOf("chrome://")&&require(["models/sites"],function(e){e.keyed[n[0].url]&&null==e.keyed[n[0].url].date.destroyed?e.keyed[n[0].url].activeTime=e.keyed[n[0].url].activeTime+1:e.keyed[n[0].url]})})},1e3)}(),chrome.runtime.onMessage.addListener(function(e,t,n){return 1==e.getSurveyDetails&&n({receiveSurveyDetails:!0,question:m.Survey.Question,answers:m.Survey.Answers,type:m.Survey.Type}),!0}),chrome.runtime.onMessage.addListener(function(e,t,n){1==e.closeSurvey&&h.Remove("Survey")}),chrome.runtime.onMessage.addListener(function(e,t,n){if(1==e.sendSurveyResponse){z=localStorage.z;for(var o=m.Survey.Answers.split(",").filter(function(e){return""!=e}),a=0;a<o.length;++a)if(o[a]==e.response){var r=a,i=String.fromCharCode(148)+z+String.fromCharCode(r)+z+z;""!==m.Survey.Cid&&d.senddata(m.Survey.Cid,i);break}}}),chrome.runtime.onMessage.addListener(function(e){1==e.muteSoundFromPage&&chrome.runtime.sendMessage({queryTabs:!0,tabData:{}},function(e){for(var t=0;t<e.length;++t)chrome.runtime.sendMessage({tabsUpdate:!0,tabID:e[t].id,tabData:{muted:!0}})})}),chrome.runtime.onMessage.addListener(function(e){1==e.open&&chrome.runtime.sendMessage({windowsUpdate:!0,windowId:parseInt(localStorage.messageDialogWinID),winData:{focused:!0}})}),chrome.runtime.onMessage.addListener(function(e){1==e.close&&clearInterval(L)});var P=0;function H(){chrome.runtime.sendMessage({storeLocal:!0,data:{muteSound:!1}}),chrome.runtime.sendMessage({queryTabsUnmuteAll:!0})}function q(){window.clearInterval(updateStatusViewShareInterval),window.clearInterval(updateStatusIconConnectionState),clearTimeout(f);var t="";updateStatusIconConnectionState=setInterval(function(){chrome.runtime.sendMessage({getConnectionState:!0},function(e){"connected_TUTOR"!=e.connectionState?require(["modules/cicregistration"],function(e){e=e.cic.cloudstate();localStorage.cloudState=e,chrome.runtime.sendMessage({storeLocal:!0,data:{cloudState:e}}),"21"==(t="21"==e?e:t)&&"21"!=e&&(null!=localStorage.roomSpec&&o.instance.STATUS(localStorage.roomspec,0),t="")}):A("connected_TUTOR")})},2e3)}function V(e){var t,n;window.clearInterval(updateStatusIconConnectionState),window.clearInterval(updateStatusViewShareInterval),t=(new Date).getTime(),updateStatusViewShareInterval=setInterval(function(){500<=(n=(new Date).getTime())-t&&(t=n,function e(t){f=0==v||null==v?(chrome.runtime.sendMessage({setIcon:!0,iconPath:{16:"images/CIC16Blank.png",32:"images/CIC32Blank.png",48:"images/CIC48Blank.png",128:"images/CIC128Blank.png"}}),v=!0,clearTimeout(f),setTimeout(function(){e(t)},t)):(chrome.runtime.sendMessage({setIcon:!0,iconPath:{16:"images/CIC16Connected.png",32:"images/CIC32Connected.png",48:"images/CIC48Connected.png",128:"images/CIC128Connected.png"}}),v=!1,clearTimeout(f),setTimeout(function(){e(viewShare)},t))}(e))},5)}function W(n,o){var a=localStorage.z;if(n||""==n){0===m.Connections.length&&(T=n),"none"==o?o=2:"workComplete"==o?o=1:"needHelp"==o?o=2:"urgentHelp"==o&&(o=3);let e=String.fromCharCode(204,0,0,0,o,0),t=String.fromCharCode(74,0);for(;e.length<34;)e+=a;for(;t.length<34;)t+=a;for(var r in m.Connections)d.senddata(r,e),d.senddata(r,t+c.Encode(n,r)+a)}else T&&(W(T),T=void 0)}function F(e,t){e=Whammy.fromImageArray(e,1),t={video:{data:window.URL.createObjectURL(e),matches:JSON.stringify(t)}};"1"!=localStorage.expired&&null!=localStorage.expired&&n.priority.enqueue(t)}function G(e){var t=(e,t=2)=>String(e).padStart(t,"0"),n=e.getFullYear(),o=t(e.getMonth()+1),a=t(e.getDate()),r=t(e.getHours()),i=t(e.getMinutes()),s=t(e.getSeconds()),c=t(e.getMilliseconds()),e=-e.getTimezoneOffset();return n+"-"+o+"-"+a+"T"+r+":"+i+":"+s+"."+c+(0<=e?"+":"-")+t(Math.floor(Math.abs(e)/60))+":"+t(Math.abs(e)%60)}return chrome.runtime.onMessage.addListener(function(e,t,n){1==e.sendHelpRequest&&W(e.message,e.alertType)}),chrome.runtime.onMessage.addListener(function(e,t,n){1==e.cancelHelpRequest&&function(){for(var e in m.Connections)d.senddata(e,String.fromCharCode(r.SOS_CLEAR));let t=String.fromCharCode(75,0);for(;t.length<34;)t+=String.fromCharCode(0);for(var e in m.Connections)d.senddata(e,t)}()}),chrome.runtime.onMessage.addListener(function(e,t,n){1==e.saveMessageDataForRefresh&&(localStorage.beenRefreshed=!1,localStorage.message=e.message,localStorage.reopened=!0,localStorage.userSetTimeout=e.timeout,localStorage.isRandomSelectIcon=e.isRandomSelectIcon,localStorage.receivedDateTime=e.receivedDateTime,function(e){e=((new Date).getTime()-new Date(e).getTime())/1e3,e=Math.round(localStorage.userSetTimeout-e);localStorage.timeout=e<=0?0:e}(e.receivedDateTime))}),chrome.runtime.onMessage.addListener(function(e,t,n){1==e.savePolicyDataForRefresh&&(localStorage.beenRefreshed=!1,localStorage.policyTextRTF=e.message,localStorage.reopened=!0,localStorage.scrollTop=e.scrollTop)}),chrome.runtime.onMessage.addListener(function(e,t,n){1==e.videoScreenClosed&&(b=!1)}),chrome.runtime.onMessage.addListener(function(e,t,n){1==e.setUseDesktopImageDataURLCICCore&&(b=e.useDesktopImageDataURL)}),chrome.runtime.onMessage.addListener(function(e,t,n){return 1==e.activePage&&(localStorage.winID=t.tab.windowId),n({}),!0}),{core:I}});