!function(e){"function"==typeof define&&define.amd?define(["settings","modules/image","modules/translate","comms.websocket","socket","logger","background/subscription","background/socketHandlers","background/thumb/videoStream","modules/ciccrypto","models/logindata","models/webdata","background/websocket","modules/altdebug"],e):"object"==typeof exports&&(module.exports=e(require("settings"),require("modules/image"),require("modules/translate"),require("comms.websocket"),require("socket"),require("logger"),require("background/subscription"),require("background/socketHandlers"),require("background/thumb/videoStream"),require("modules/ciccrypto"),require("models/logindata"),require("models/webdata"),require("background/websocket"),require("modules/altdebug")))}(function(r,s,e,n,l,a,i,c,d,t,o,u,g,m){var S;function v(){chrome.runtime.onMessage.addListener(function(e,a,t){1==e.createCanvasHelper&&h()}),m.altdebug("starting initialise"),m.saveLogs();let e=localStorage.saveLogs;var a=e&&null!=e.split("@")[1]&&60<=parseInt(e.split("@")[1])?e.split("@")[1]:60;S&&clearInterval(S),localStorage.freqSaveLogs=a,S=setInterval(function(){m.saveLogs()},1e3*a),null!=localStorage.gatewayAddress&&"undefined"!=localStorage.gatewayAddress&&"false"==localStorage.ignoreProgress&&chrome.runtime.sendMessage({storeLocal:!0,data:{updateProgressBarWidth:20}}),setInterval(function(){require(["models/useridentity","models/deviceinfo"],function(e,a){Promise.all([NSLibrary.settings.get.managed(),e.refresh.device(),e.refresh.user(),a.retrieve.deviceAsset(),a.retrieve.deviceHostname(),a.retrieve.deviceSerial(),a.retrieve.location()]).then(function(e){var a=e[0],t=e[1],o=e[2],r=e[3],s=e[4],n=e[5],l=e[6],e=o.indexOf("@");e&&(currentUser=o.substring(0,e)),t?localStorage.macAddress=t.long:localStorage.macAddress&&"undefined"!=localStorage.macAddress||(localStorage.macAddress=o),(!localStorage.clientName||a&&a.resetClientName)&&e&&(localStorage.clientName=currentUser.replace(/\s/g,"").substring(0,30).toUpperCase(),localStorage.userName=o),r?chrome.runtime.sendMessage({storeLocal:!0,data:{deviceAssetId:r.devAssetId}}):chrome.runtime.sendMessage({storeLocal:!0,data:{deviceAssetId:localStorage.clientName}}),s?chrome.runtime.sendMessage({storeLocal:!0,data:{deviceHostname:s.devHostname}}):chrome.runtime.sendMessage({storeLocal:!0,data:{deviceHostname:""}}),n?chrome.runtime.sendMessage({storeLocal:!0,data:{serialNumber:n.serialNumber}}):chrome.runtime.sendMessage({storeLocal:!0,data:{serialNumber:localStorage.clientName}}),l?chrome.runtime.sendMessage({storeLocal:!0,data:{location:l.annotatedLocation}}):chrome.runtime.sendMessage({storeLocal:!0,data:{location:localStorage.location}})})})},18e5),null!=localStorage.deviceID&&null!=localStorage.deviceID&&"undefined"!=localStorage.deviceID&&require(["modules/ciccrypto"],function(e){e.updateDevice()}),setInterval(function(){u.persistWeb()},5e4);let t=null,o=(new Date).getDay();setInterval(function(){if(o&&null!=localStorage.appAllowedTimes){let e=localStorage.appAllowedTimes.split(";")[o];var a;""!=e&&null!=e&&(allowedHoursStart=e.split("-")[0],allowedHoursEnd=e.split("-")[1],allowedHoursStartTime=new Date,allowedHoursStartTime.setHours(allowedHoursStart.split(":")[0]),allowedHoursStartTime.setMinutes(allowedHoursStart.split(":")[1]),allowedHoursStartTime.setSeconds(0),allowedHoursStartTime.setMilliseconds(0),allowedHoursEndTime=new Date,allowedHoursEndTime.setHours(allowedHoursEnd.split(":")[0]),allowedHoursEndTime.setMinutes(allowedHoursEnd.split(":")[1]),allowedHoursEndTime.setSeconds(0),allowedHoursEndTime.setMilliseconds(0),a=g.isItCurrentlyInAllowedHours(allowedHoursStartTime,allowedHoursEndTime),null==t&&(t=a),"true"==localStorage.activityMonitorChanged?(localStorage.activityMonitorChanged=!1,t!=a&&(t=a)):t!=a&&(localStorage.allowSendLoginMetering=!0,localStorage.allowSendWebMetering=!0,localStorage.useAllowedEndTime=0==a,g.sendLogin(),g.sendInternet(),t=a))}},2e3),require(["modules/ciccore"],function(e){e.core.batteryStatus(),e.core.networkType(),e.core.persistentScreenshots()}),chrome.runtime.sendMessage({setIcon:!0,iconPath:{16:"images/CIC16Disconnected.png",32:"images/CIC16Disconnected.png",48:"images/CIC16Disconnected.png",128:"images/CIC16Disconnected.png"}}),localStorage.setItem("canEnableHelpRequestChatIfSet","false");screen.width,screen.height;localStorage.setItem("screenWidth",screen.width),localStorage.setItem("screenHeight",screen.height);screen.availWidth,screen.availHeight;h(),i.on.interval.id||i.on.interval.setInterval(6e4),void 0===localStorage.pinServerAddress&&(localStorage.pinServerAddress=""),void 0===localStorage.pinServerPort&&(localStorage.pinServerPort=""),"true"==localStorage.getItem("useLegacyThumbnail")?d.silence(!0):d.silence(!1),null!=localStorage.gatewayAddress&&"undefined"!=localStorage.gatewayAddress&&"false"==localStorage.ignoreProgress&&chrome.runtime.sendMessage({storeLocal:!0,data:{updateProgressBarWidth:30}}),r.update.localGateway().then(function(){null!=localStorage.gatewayAddress&&"undefined"!=localStorage.gatewayAddress&&"false"==localStorage.ignoreProgress&&chrome.runtime.sendMessage({storeLocal:!0,data:{updateProgressBarWidth:60}}),n.mechanism?n.mechanism.isStale()&&(chrome.runtime.sendMessage({storeLocal:!0,data:{connectionState:"disconnected"}}),n.mechanism.recycle()):(null!=localStorage.gatewayAddress&&"undefined"!=localStorage.gatewayAddress&&"false"==localStorage.ignoreProgress&&chrome.runtime.sendMessage({storeLocal:!0,data:{updateProgressBarWidth:60}}),new l(c))})}function h(){var a,t;s.canvas||(m.altdebug("294 creating canvas"),s.canvas=document.createElement("canvas"),s.canvas.width=512,s.canvas.height=384,a=s.canvas.getContext("2d"),(t=document.createElement("img")).onload=function(){a.drawImage(this,0,0);var e=s.canvas.toDataURL();localStorage.defaultImg=e.substring(e.indexOf(",")+1),s.canvas.width=View.width,s.canvas.height=View.height,t.onload=function(){a.drawImage(this,0,0),localStorage.defaultViewImg=s.canvas.toDataURL()},t.src="images/blankview.png"},t.src="images/screen.png",e())}return new i(i.keys.interval,function(e){e&&(e.cancelBubble=!0),CSParams.Opened&&n.instance&&n.instance.websocket&&!n.mechanism.isStale()||v();var a,t=!1;for(a in CSParams.Connections){var o=CSParams.Connections[a];o.thumbi&&(++o.thumbs,o.thumbs>=o.thumbi&&(t=!0)),o.webpoll}t&&(d.confirmStream(),s.takeScreenshot(!0)),null!=n.instance&&n.instance.websocket&&CSParams.Opened&&((e=localStorage.roomspec)==CSParams.Room.Name||CSParams.Room.Changed||(CSParams.Room.Name=e,m.altdebug("STATUS - room: "+e),null!=e&&n.instance.STATUS(e,0)))}).setInterval(6e4),v});