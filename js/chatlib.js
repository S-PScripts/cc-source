!function(e){"function"==typeof define&&define.amd?define(["models/Tab","Transmit","utf8","student"],e):"object"==typeof exports&&(module.exports=e(require("models/Tab"),require("Transmit"),require("utf8"),require("student")))}(function(a,r,n,t){chats={instance:void 0};let c=String.fromCharCode(0);var s=new Map([[/:-?D|:grin:/gi,"😀"],[/:-?\)|:smile:/gi,"🙂"],[/:-?\(|:sad:/gi,"😟"],[/:oops:/gi,"😳"],[/:-?o|:eek:/gi,"😮"],[/:shock:/gi,"😧"],[/:\?:/gi,"❓"],[/:\?\?\?:|:-?\?/gi,"🤨"],[/8-?\)|:cool:/gi,"😎"],[/:lol:/gi,"😂"],[/:-?x|:mad:|:angry:|:@/gi,"😠"],[/:-?P|:razz:/gi,"😝"],[/:cry:/gi,"😭"],[/:evil:|:gavin:/gi,"👿"],[/:twisted:/gi,"😈"],[/:roll:/gi,"🙄"],[/;-?\)|:wink:/gi,"😉"],[/:!:/gi,"❗"],[/:idea:/gi,"💡"],[/:arrow:/gi,"➡"],[/:-?\||:neutral:/gi,"😐"]]);class l{constructor(e,a){this.chatID=null!=e?e:-1,this.CID=a,this.target=!1,this.isChatting=0,this.lastTab=!1,this.cachedMessages=[],this.title="",this.members=[],this.removeURL=!0,this.processMessage=!0}static startChat(e){l.members=[],l.cachedMessages=[],this.target=!1,l.makeTab(e),require(["background/CLIENT"],function(e){e.Lock.unlockClient()})}static makeTab(r){a.Make("chat.html","Chat",!0).then(e=>{localStorage.tabID=e.tab.id,r.isChatting=1,r.chatTimer=window.setInterval(()=>{t.TabStore[e.key]&&"true"!=localStorage.hangupCalled||(window.clearInterval(r.chatTimer),l.eject(localStorage.tabToDelete),l.closeChat(r)),"true"==localStorage.hangupCalled&&(window.clearInterval(r.chatTimer),localStorage.hangupCalled=!1)},1500),l.chatPageStatusTimer=window.setInterval(()=>{chrome.runtime.sendMessage({queryTabs:!0,tabData:{active:!0}},e=>{var s=localStorage.chatUrl;void 0!==e[0]&&e[0].url===s?(r.processMessage=!0,r.removeURL=!1):chrome.runtime.sendMessage({historySearch:!0,data:{text:s,maxResults:1}},e=>{1==e.length&&chrome.runtime.sendMessage({queryTabs:!0,tabData:{active:!1}},e=>{var a,t=!0;for(a of e)if(a.url===s){t=!1;break}r.processMessage=!1,r.removeURL=!!t})})})},500)})}static sendChatCommand(e,a,t){var s=String.fromCharCode(130,0)+e.chatID+String.fromCharCode(a,0,0,0);for(s+="Complex Name";s.length<26;)s+=c;s+=n.Encode(t,e.CID)+c,s+=n.Encode(localStorage.clientName,e.CID)+c,new r(e.CID,s).Send(s)}static endChat(e){"false"==localStorage.hangupCalled&&(e.CID&&l.sendChatCommand(3,""),e.title="",e.isChatting=0,require(["background/CLIENT"],function(e){"false"==localStorage.unlockCalled&&e.Lock.lockClient()}))}static sendChatJoin(e){l.sendChatCommand(e,2,"")}static addMessage(e,a,t){e.processMessage||1==(null!=localStorage.showWebRTCTutorFullscreen&&localStorage.showWebRTCTutorFullscreen)||1==(null!=localStorage.showWebRTCTutorWindowed&&localStorage.showWebRTCTutorWindowed)?l.createMessageElement(e,a,t):this.removeURL?chrome.runtime.sendMessage({deleteUrl:!0,url:chatUrl},l.onUrlDeleted(a,t)):(l.eject(e.tabID),l.createMessageElement(e,a,t))}static addJoinedMessage(e,a){var t;e.members.indexOf(a)<0&&(t="<b style='color:#006400'>"+NSLibrary.Translate("PLACEHOLDER_HAS_JOINED",a)+"</b>",i(e,t),setTimeout(function(){chrome.runtime.sendMessage({addJoinedMessage:!0,translatedText:t,instance:e}),e.members.push(a)},800))}static addLeftMessage(e,a){a=NSLibrary.Translate("PLACEHOLDER_HAS_LEFT",a);i(e,a),chrome.runtime.sendMessage({addLeftMessage:!0,cachedMessages:JSON.stringify(l.cachedMessages),translatedText:a,instance:e})}static studentEndChat=function(e,a){l.eject(a),l.endChat(e),require(["background/CLIENT"],function(e){"false"==localStorage.unlockCalled&&e.Lock.lockClient()})};static sendMessage=function(e,a){0<a.replace(/\s/g,"").length&&(l.sendChatCommand(e,4,a),l.addMessage(e,localStorage.clientName,a))};static setTarget(e,a){chrome.runtime.sendMessage({chatMessageUpdate:!0,cachedMessages:JSON.stringify(e.cachedMessages),instance:e,element:a})}static setTitle(e,a){e.title=a&&""!==a?NSLibrary.Translate("TOPIC")+": "+a:""}static createTabWithMessage(e,a,t){l.makeTab(e),l.createMessageElement(e,a,t)}static createMessageElement(e,a,t){t=this.swapInEmojis(t);t="<b>"+a+" "+NSLibrary.Translate("SAYS")+": </b><br/>&nbsp;&nbsp;&nbsp;"+l.detectLinks(t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"));i(e,t),chrome.runtime.sendMessage({createMessageElement:!0,translatedText:t,instance:e})}static swapInEmojis(e){let t=e;return s.forEach(function(e,a){t=t.replace(a,e)}),t}static updateTabStoreAndCreateTabWithMessage(e,a){window.clearInterval(l.chatPageStatusTimer),window.clearInterval(l.chatTimer),l.clearTabID("Chat"),l.createTabWithMessage(e,a)}static onUrlDeleted(e,a){this.updateTabStoreAndCreateTabWithMessage(e,a)}static onUrlRemoved(){window.clearInterval(l.chatPageStatusTimer),window.clearInterval(l.chatTimer),l.clearTabID("Chat")}static clearTabID(e){e=t.TabStore[e];e&&a.clearId(e)}static detectLinks(e){return e.replace(/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi,function(e){return'<a href="'+e+'">'+e+"</a>"})}static instance(e){if(!e)return chats.instance;chats.instance=e,localStorage.chatInstance=JSON.stringify(chats.instance)}static instance(a,e){if(!a)return JSON.parse(localStorage.chatInstances)[e];{chats.instance=a,localStorage.CID=a.CID;let e=JSON.parse(localStorage.chatInstances);0<Object.keys(e).length&&Object.keys(e).indexOf(chats.instance.CID);e[chats.instance.CID]=JSON.stringify(a),localStorage.chatInstances=JSON.stringify(e),localStorage.chatInstance=JSON.stringify(a)}}static eject(s){var e=chats.instance;let r=JSON.parse(localStorage.chatInstances);Object.keys(r).forEach(function(e,a,t){JSON.parse(r[e]).tabID==s&&(delete r[e],localStorage.chatInstances=0==Object.keys(r).length?JSON.stringify({}):JSON.stringify(r))}),null!=e&&e.removeURL&&localStorage.chatUrl&&1!=(null!=localStorage.showWebRTCTutorFullscreen&&localStorage.showWebRTCTutorFullscreen)&&1!=(null!=localStorage.showWebRTCTutorWindowed&&localStorage.showWebRTCTutorWindowed)?chrome.runtime.sendMessage({deleteUrl:!0,url:localStorage.chatUrl},function(){l.onUrlRemoved(),a.Remove("Chat"+s)}):(window.clearInterval(l.chatTimer),window.clearInterval(l.chatPageStatusTimer),a.Remove("Chat"+s))}static closeChat(e){"false"==localStorage.hangupCalled&&(e.CID&&(l.sendChatCommand(e,3,""),require(["background/CLIENT"],function(e){"false"==localStorage.unlockCalled&&e.Lock.lockClient()})),e.title="",e.isChatting=0)}}function i(e,a){(e=null!=e&&e.constructor!=Object?JSON.parse(e):e).cachedMessages.push(a);let t=JSON.parse(localStorage.chatInstances),s=JSON.parse(t[e.CID]);null==s.tabID&&(s.tabID=localStorage.tabID),s.cachedMessages.push(a),t[e.CID]=JSON.stringify(s),localStorage.chatInstances=JSON.stringify(t)}return l});