!function(e,t){if("function"==typeof define&&define.amd)define(["comms","lib/batch","background/storage","models/useridentity","pubsub","modules/debug","modules/altdebug"],t);else if("object"==typeof exports)module.exports=t(require("comms"),require("lib/batch"),require("background/storage"),require("models/useridentity"),require("pubsub"),require("modules/debug"),require("modules/altdebug"));else{e.NSLibrary=e.NSLibrary||{content:{}};let o=e.NSLibrary;["squash"].forEach(e=>{o[e]=o[e]||{}}),o.settings={...o.settings,...t.call(o.Comms,o.squash,require("background/storage"),require("models/useridentity"),require("pubsub"),require("modules/debug"),require("modules/altdebug"))}}}(this,function(e,o,t,a,n,r,i){let l={};var c={area:void 0};function s(){}return l.handleChange=function(o,e){var t;if(r("Storage event received from: "+e),r(JSON.stringify(o)),"local"==e){if(i.altdebug("49 settings location == local"),o.enableSupportTool&&(localStorage.enableSupportTool=o.enableSupportTool.newValue),o.alternateEmailDomain&&(i.altdebug("55 settings changes.alternateEmailDomain: "+o.alternateEmailDomain.newValue),localStorage.alternateEmailDomain=o.alternateEmailDomain.newValue),o.bookwidgetsSSO&&(localStorage.bookwidgetsSSO=o.bookwidgetsSSO.newValue),o.unlocktimeout&&(localStorage.unlocktimeout=o.unlocktimeout.newValue),o.reconnectTimeout&&(localStorage.reconnectTimeout=o.reconnectTimeout.newValue),o.recordAllWebsiteActivity&&(localStorage.recordAllWebsiteActivity=o.recordAllWebsiteActivity.newValue),o.saveLogs&&(localStorage.saveLogs=o.saveLogs.newValue),o.runModifiedCode&&(localStorage.runModifiedCode=o.runModifiedCode.newValue),o.acitivitymonitorfrequency&&(localStorage.acitivitymonitorfrequency=o.acitivitymonitorfrequency.newValue),o.accountID||o.siteID||o.region||o.gatewayAddress||o.port||o.useLegacyThumbnail)if(o.gatewayAddress||o.port)require(["lib/batch"],function(e){e=e.squash(e.token.recycleSocket,3500);e.expire().then(e).then(function(){void 0!==NSLibrary.Comms&&NSLibrary.Comms.WebSockets.active.recycle()})});else if(o.useLegacyThumbnail){if(require(["background/thumb/videoStream"],function(e){1==o.useLegacyThumbnail.newValue?e.silence(!0):e.silence(!1)}),null!=localStorage.tracks){let e=JSON.parse(localStorage.tracks);e.forEach(function(e){e.stop()}),localStorage.vid=null}}else require(["modules/cicregistration"],function(e){e.cic.register(!1,null!=o.accountID?o.accountID.newValue:void 0,null!=o.siteID?o.siteID.newValue:void 0,null!=o.region?o.region.newValue:void 0,s)})}else"managed"==e&&(i.altdebug("107 settings location == managed"),o.options&&o.options.newValue?(o.options.newValue,require(["models/useridentity"],function(e){e.refresh.device().then(function(e){e&&(localStorage.macAddress=e.long)})}),require(["models/deviceinfo"],function(e){e.retrieve.hardware().then(function(e){e?(localStorage.model=e.model,localStorage.manufacturer=e.manufacturer):(localStorage.model="",localStorage.manufacturer="")})}),localStorage.model="",localStorage.manufacturer="",require(["models/deviceinfo"],function(e){e.retrieve.deviceAsset().then(function(e){localStorage.deviceName=e?e.devAssetId:localStorage.clientName})}),require(["models/deviceinfo"],function(e){e.retrieve.deviceHostname().then(function(e){localStorage.deviceHostname=e?e.devHostname:""})}),require(["models/deviceinfo"],function(e){e.retrieve.deviceSerial().then(function(e){localStorage.serialNumber=e?e.serialNumber:localStorage.clientName})}),require(["models/deviceinfo"],function(e){e.retrieve.location().then(function(e){localStorage.location=e?e.annotatedLocation:""})}),t={},(e=o.options.newValue.accountID)&&(t.accountID=e.trim()),(e=o.options.newValue.siteID)&&(t.siteID=e.trim()),(e=o.options.newValue.region.trim())&&(t.region=e),null!=(e=o.options.newValue.enableSupportTool)&&(t.enableSupportTool=e),null!=(e=o.options.newValue.alternateEmailDomain)&&(i.altdebug("221 settings alternateEmailDomain "+e),t.alternateEmailDomain=e),null!=(e=o.options.newValue.bookwidgetsSSO)&&(t.bookwidgetsSSO=e),null!=(e=o.options.newValue.unlocktimeout)&&(t.unlocktimeout=e),null!=(e=o.options.newValue.reconnectTimeout)&&(t.reconnectTimeout=e),null!=(e=o.options.newValue.recordAllWebsiteActivity)&&(t.recordAllWebsiteActivity=e),null!=(e=o.options.newValue.saveLogs)&&(t.saveLogs=e),null!=(e=o.options.newValue.runModifiedCode)&&(t.runModifiedCode=e),null!=(e=o.options.newValue.acitivitymonitorfrequency)&&(t.acitivitymonitorfrequency=e),chrome.runtime.sendMessage({storeLocal:!0,data:t})):(localStorage.accountID="",localStorage.siteID="",localStorage.region="",localStorage.enableSupportTool="",localStorage.alternateEmailDomain="",localStorage.bookwidgetsSSO="",localStorage.unlocktimeout="",localStorage.reconnectTimeout="",localStorage.recordAllWebsiteActivity="",localStorage.acitivitymonitorfrequency="",localStorage.saveLogs="",localStorage.runModifiedCode="",chrome.runtime.sendMessage({storeLocal:!0,data:{gatewayAddress:"",gatewayPort:443}})))},l.load=function(t,a=null){a=a||c.area||null;const n=!/^(managed|local)$/.test(`${a}`);return new Promise((o,e)=>{n&&e("Illegal storage area"),chrome.runtime.sendMessage({getWhichStorage:!0,area:a,key:t},e=>{o(e[t])})})},l.get={local:function(){return new Promise(function(o,t){try{chrome.storage.local.get(["passKey","activeMetaURL"],function(e){r("loadChromeStorageLocal"),o(e)})}catch(e){t(e)}})},managed:function(){return new Promise(function(o,t){try{chrome.runtime.sendMessage({getOptions:!0},function(e){e&&e.options?o(e.options):o(void 0)})}catch(e){t(e)}})}},l.update={pin:function(e){r("incoming request - updatePin"),e.indexOf(":")<0?(localStorage.pinServerAddress=e,localStorage.pinServerPort=443):(e=e.split(":"),localStorage.pinServerAddress=e[0],localStorage.pinServerPort=e[1])},options:function(a,n){r("incoming request - updateOptions"),new Promise(function(o,e){chrome.storage.managed.get("options",function(e){(a=e&&e.options&&e.options.passKey?e.options.passKey:a)&&o(a.match(/[0-9a-f]{2}/g))})}).then(function(e){var o,t=new Uint8Array(i17n);for(o in e)t[o]=parseInt(e[o],16);n&&n.url&&(0!==n.url.replace(/chrome-extension:\/\/.+\/options.html/g,"").length?chrome.storage.local&&chrome.runtime.sendMessage({getLocal:!0,data:"i17n"},function(e){e.i17n&&chrome.runtime.sendMessage({createTab:!0,tabData:{url:e.i17n}})}):chrome.runtime.sendMessage({storeLocal:!0,data:{i17n:n.url}})),chrome.runtime.sendMessage({storeLocal:!0,data:{passKey:a}})})},localGateway:function(){return new Promise(function(e,o){r("managed storage not found"),gateway={address:localStorage.gatewayAddress,port:localStorage.gatewayPort},gateway.port||(gateway.port=443),localStorage.gatewayAddress=gateway.address,localStorage.gatewayPort=gateway.port,e(gateway)})},pfxClear:function(){var e=$(new TextEncoder("utf-8").encode(chrome.runtime.getManifest().name)),o=new ArrayBuffer(8+e.length);new Uint8Array(o).set(e);var t=new DataView(o);t.setUint32(e.length,1936941424,!0),t.setUint32(4+e.length,1685221239,!0),crypto.subtle.digest({name:"SHA-256"},o).then(function(e){var o,t=new Uint8Array(e),a=[];for(o in t)a.push(("0"+t[o].toString(16)).slice(-2));NSLibrary.settings.update.options(a.join(""))})}},l.loadManagedAccountAndSite=function(){return new Promise(function(a,n){chrome.runtime.sendMessage({getOptionsManagedAccountsandSite:!0}),chrome.runtime.onMessage.addListener(function(o,e,t){1==o.getOptionsManagedAccountsandSiteResponse&&(1==o.isManaged?(i.altdebug("586 settings - store.options OK"),localStorage.saveLogs=o.store.options.saveLogs,localStorage.runModifiedCode=o.store.options.runModifiedCode,i.altdebug("589 settings - NOT RUNNING - MODIFED"),require(["models/deviceinfo"],function(e){e.retrieve.deviceSerial().then(function(e){localStorage.siteID=o.store.options.siteID.trim(),localStorage.accountID=o.store.options.accountID.trim(),localStorage.region=o.store.options.region.trim(),localStorage.enableSupportTool=o.store.options.enableSupportTool,localStorage.unlocktimeout=o.store.options.unlocktimeout,localStorage.reconnectTimeout=o.store.options.reconnectTimeout,localStorage.recordAllWebsiteActivity=o.store.options.recordAllWebsiteActivity,localStorage.acitivitymonitorfrequency=o.store.options.acitivitymonitorfrequency,localStorage.alternateEmailDomain=o.store.options.alternateEmailDomain,localStorage.bookwidgetsSSO=o.store.options.bookwidgetsSSO,e?(i.altdebug("602 settings - DEVICE SERIAL RETRIEVED: "+e),chrome.runtime.sendMessage({storeSync:!0,data:{IsManaged:!0}}),localStorage.isManaged=!0):(i.altdebug("609 settings - DEVICE SERIAL NOT RETRIEVED"),chrome.runtime.sendMessage({storeSync:!0,data:{IsManaged:!1}}),localStorage.isManaged=!1),a({accountID:localStorage.accountID,siteID:localStorage.siteID,region:localStorage.region,enableSupportTool:localStorage.enableSupportTool,alternateEmailDomain:localStorage.alternateEmailDomain,bookwidgetsSSO:localStorage.bookwidgetsSSO,unlocktimeout:localStorage.unlocktimeout,reconnectTimeout:localStorage.reconnectTimeout,recordAllWebsiteActivity:localStorage.recordAllWebsiteActivity,acitivitymonitorfrequency:localStorage.acitivitymonitorfrequency})})})):(chrome.runtime.sendMessage({storeSync:!0,data:{IsManaged:!1}}),localStorage.isManaged=!1,i.altdebug("625 settings - localStorage.isManaged == false"),n(void 0)))})})},l.setSelectedGatewayAddressPort=function(){return new Promise(function(e,o){null===localStorage.getItem("flag")||"null"==localStorage.getItem("flag")?(localStorage.setItem("flag",1),e({address:localStorage.gatewayAddress,port:localStorage.port,flag:"1"})):"1"===localStorage.getItem("flag")?e({address:localStorage.gatewayAddress,port:localStorage.port,flag:"1"}):e({address:localStorage.secondaryAddress,port:localStorage.secondaryPort,flag:"0"})})},l});