define(["background/storageSync","models/useridentity","modules/cicregistration","models/Tab","models/TabData"],function(e,n,i,r,a){var s={live:[],archive:[]},t=[];function o(){s.archive=[]}function l(e){domain="about:blank"===e?e:d(e);let t=s.live[e];return"chrome://newtab/"==e&&(t.activeTime=0),!r.mustFilter(e)&&(!i.cic.shouldBlockSiteIternetRestrictions(t.url)||0!=localStorage.connectionCount&&null!=localStorage.connectionCount)?{starttime:c(t.date.created),endtime:c(t.date.destroyed),url:domain,page:t.url.substring(domain.length),title:t.title,activetime:t.activeTime,fullURL:t.url,status:"Approved"}:{starttime:c(t.date.created),endtime:c(t.date.destroyed),url:domain,page:t.url.substring(domain.length),title:t.title,activetime:t.activeTime,fullURL:t.url,status:"Blocked"}}function d(e){return e.match([".+:///*[^/]+"])[0]}function c(e){return e&&"[object Date]"===Object.prototype.toString.call(e)?e.toISOString():e||void 0}n.refresh.user(),n.refresh.device();var u={save:function(){chrome.runtime.sendMessage({storeSync:!0,data:{sites:JSON.stringify(Object.keys(s.live).map(l).concat(s.archive).concat(t))}})},load:function(){chrome.runtime.sendMessage({getSync:!0,data:["sites","storedTimes","ids"]},function(i){new Promise(function(e,t){0<Object.keys(i).length&&null!=i.sites&&null!=i.storedTimes&&null!=i.ids&&(dataTemp=JSON.parse(i.sites),dataTemp.map(function(e){var t;return null!=e.endtime&&null!=e.endtime||(e.endtime=(function(e){if(parseInt(e.storedTimes.timestamp)<new Date(e.storedTimes.inHoursEndTime).getTime())return!0}(t=i)?new Date(parseInt(t.storedTimes.timestamp)):new Date(null!=t.storedTimes.inHoursEndTime?t.storedTimes.inHoursEndTime:parseInt(t.storedTimes.timestamp))).toISOString(),e.activeTime=null!=(t=e).startTime?Math.round((new Date(t.endTime).getTime()-new Date(t.startTime).getTime())/1e3):t.activeTime),e.loginID=i.ids.loginID,e.loggedOnUser=i.ids.loggedOnUser,e}),e(dataTemp))}).then(function(t){require(["background/websocket"],function(e){e.sendInternetPostLogin(t).then(m).then(e.sendInternetOnRestart())})})})}};function m(){return new Promise(function(e,t){o(),e()})}return u.load(),{keyed:s.live,array:function(){return Object.keys(s.live).map(l).concat(s.archive).concat(t)},persistence:u,create:function(e){var t;(t=s.live[e.url])&&t.date.destroyed&&(s.archive.push(l(e.url)),delete s.live[e.url]);var i=s.live[e.url]||(t=e.url,i={tabs:[],url:t,date:{created:new Date,destroyed:void 0},title:void 0,activeTime:0,user:n.get().user},s.live[t]=i);return i.tabs.includes(e.id)||(i.tabs[e.id]={tab:e.id,window:e.windowId}),i.title=i.title||e.title,(e={id:e.id,url:e.url,title:i.title}).title&&a.send(e),i},archive:function(e){s.live[e]&&(s.archive.push(l(e)),delete s.live[e])},archiveDestroyed:function(){Object.keys(s.live).map(e=>s.live[e]).filter(e=>e.date.destroyed).map(function(e){delete s.live[e.url]})},clearArchive:o}});