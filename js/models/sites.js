define(["background/storageSync","models/useridentity","modules/cicregistration","models/Tab","models/TabData","modules/ciccore"],function(e,n,i,r,a,o){var s={live:[],archive:[]},t=[];function l(){s.archive=[]}function d(e){domain="about:blank"===e?e:c(e);let t=s.live[e];return"chrome://newtab/"==e&&(t.activeTime=0),!r.mustFilter(e)&&(!i.cic.shouldBlockSiteIternetRestrictions(t.url)||0!=localStorage.connectionCount&&null!=localStorage.connectionCount)?{starttime:u(t.date.created),endtime:u(t.date.destroyed),url:domain,page:t.url.substring(domain.length),title:t.title,activetime:t.activeTime,fullURL:t.url,status:"Approved"}:{starttime:u(t.date.created),endtime:u(t.date.destroyed),url:domain,page:t.url.substring(domain.length),title:t.title,activetime:t.activeTime,fullURL:t.url,status:"Blocked"}}function c(e){return e.match([".+:///*[^/]+"])[0]}function u(e){return e&&"[object Date]"===Object.prototype.toString.call(e)?o.core.dateToLocaleISOString(e):e||void 0}n.refresh.user(),n.refresh.device();var m={save:function(){chrome.runtime.sendMessage({storeSync:!0,data:{sites:JSON.stringify(Object.keys(s.live).map(d).concat(s.archive).concat(t))}})},load:function(){chrome.runtime.sendMessage({getSync:!0,data:["sites","storedTimes","ids"]},function(i){new Promise(function(e,t){0<Object.keys(i).length&&null!=i.sites&&null!=i.storedTimes&&null!=i.ids&&(dataTemp=JSON.parse(i.sites),dataTemp.map(function(e){var t;return null!=e.endtime&&null!=e.endtime||(e.endtime=function(e){if(parseInt(e.storedTimes.timestamp)<new Date(e.storedTimes.inHoursEndTime).getTime())return!0}(t=i)?o.core.dateToLocaleISOString(new Date(parseInt(t.storedTimes.timestamp))):o.core.dateToLocaleISOString(new Date(null!=t.storedTimes.inHoursEndTime?t.storedTimes.inHoursEndTime:parseInt(t.storedTimes.timestamp))),e.activeTime=null!=(t=e).startTime?Math.round((new Date(t.endTime).getTime()-new Date(t.startTime).getTime())/1e3):t.activeTime),e.loginID=i.ids.loginID,e.loggedOnUser=i.ids.loggedOnUser,e}),e(dataTemp))}).then(function(t){require(["background/websocket"],function(e){e.sendInternetPostLogin(t).then(v).then(e.sendInternetOnRestart())})})})}};function v(){return new Promise(function(e,t){l(),e()})}return m.load(),{keyed:s.live,array:function(){return Object.keys(s.live).map(d).concat(s.archive).concat(t)},persistence:m,create:function(e){var t;(t=s.live[e.url])&&t.date.destroyed&&(s.archive.push(d(e.url)),delete s.live[e.url]);var i=s.live[e.url]||(t=e.url,i={tabs:[],url:t,date:{created:new Date,destroyed:void 0},title:void 0,activeTime:0,user:n.get().user},s.live[t]=i);return i.tabs.includes(e.id)||(i.tabs[e.id]={tab:e.id,window:e.windowId}),i.title=i.title||e.title,(e={id:e.id,url:e.url,title:i.title}).title&&a.send(e),i},archive:function(e){s.live[e]&&(s.archive.push(d(e)),delete s.live[e])},archiveDestroyed:function(){Object.keys(s.live).map(e=>s.live[e]).filter(e=>e.date.destroyed).map(function(e){delete s.live[e.url]})},clearArchive:l}});