define(["models/windows","models/sites","background/storageSync","background/webFilter","background/phraseMatch","logger"],function(d,o,t,u,l,e){var r=[],c="",b=0;function w(e){var t=r[e];return t||(r[e]=t={id:e,activeTime:0})}function a(s){return new Promise(function(e,t){var a,i=r[s];i&&i.site&&(a=i.site,1==Object.keys(a.tabs).length&&(a.date.destroyed=new Date,a.tabs=[],o.archive(i.site.url)))})}function v(e,t,a){a!==t.url&&((a=u.request(a))&&chrome.runtime.sendMessage({tabsUpdate:!0,tabID:e,tabData:{url:a}}),oldSite=o.keyed[t.url],oldSite&&oldSite.tabs[e]&&(delete oldSite.tabs[e],0===Object.keys(oldSite.tabs).length&&(oldSite.date.destroyed=new Date)))}var i={save:function(){t.set({tabs:t.sparse.deflate(r)})},load:function(){t.get("tabs").then(function(e){e.tabs&&(r=t.sparse.inflate(e.tabs))})}};return i.load(),{keyed:r,create:w,events:{activate:function(e){var t=d.keyed[e.windowId],a=Date.now(),i=r[e.tabId];(t=t||d.create(e.windowId)).activationTime=a,t.activatedTab.id===e.tabId?i||(i=t.activatedTab,r[e.tabId]=t.activatedTab):i=i||w(e.tabId),(t.activatedTab=i).site&&i.site.url&&((t=u.request(i.site.url))&&chrome.runtime.sendMessage({tabsUpdate:!0,tabID:i.id,tabData:{url:t}}))},update:function(e,t,a){var i,s,r=w(e),n=d.keyed[a.windowId];switch(n&&n.activatedTab.id===e&&(i=Date.now(),n.activationTime=i),t.status){case"loading":break;case"complete":!t.url&&r.site&&a.url!==r.site.url?v(e,r.site,a.url):!r.site||(s=u.request(a.url))&&chrome.runtime.sendMessage({tabsUpdate:!0,tabID:e,tabData:{url:s}})}if(i=o.create({id:e,url:t.url||a.url,windowId:t.windowId||a.windowId}),t.url&&(c="",r.site&&r.site.url&&v(e,r.site,t.url)),r.site=i,t.title&&r.site.url!=c){c=r.site.url,i.title=t.title;let e=new Date;(0==b||2e3<e.getTime()-b.getTime())&&(b=e,l.process(t.title,{phraseSource:4,url:a.url,tab:a}))}},remove:a,replace:function(e,t){a(t),w(e)}},persistence:i,config:{},configure:function(e){}}});