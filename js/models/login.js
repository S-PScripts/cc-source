define(["background/storageSync"],function(e){var o={archive:[]},a=!1;function n(){return new Promise(function(e,t){0!=Object.keys(o).length&&o.archive&&0<o.archive.length&&(null==o.archive[o.archive.length-1].logoutTime?o.archive.splice(0,o.archive.length-1):o.archive.splice(0,o.archive.length),chrome.runtime.sendMessage({storeSync:!0,data:{logins:o}}))})}function r(){if(o.archive&&0<o.archive.length){let e=o.archive[o.archive.length-1];return e.logoutTime||(e.duration=Math.round(((new Date).getTime()-new Date(e.loginTime).getTime())/6e4),o.archive.splice(o.archive.length-1,1),o.archive.push(e)),1==a&&1<o.archive.length&&(a=!1,o.archive.splice(0,1)),o}return{}}var l={save:function(){e.set({logins:r()})},load:function(){e.get(["logins","storedTimes","ids"]).then(function(i){new Promise(function(t,e){if(0<Object.keys(i).length){let e=i.logins;null!=e&&null!=e&&null!=e.archive&&null!=i.storedTimes&&null!=i.storedTimes.timestamp&&(e.archive.map(function(e){return null!=e.logoutTime&&null!=e.logoutTime||(e.logoutTime=new Date(parseInt(i.storedTimes.timestamp)).toISOString()),e}),t(e)),t(e)}}).then(function(t){require(["background/websocket"],function(e){e.sendLoginMeteringOnRestart(t).then(n).then(e.sendLoginsOnRestart())})})})}};return l.load(),{logins:o,registerLogout:function(){if(o.archive&&null!=o.archive[o.archive.length-1]&&null==o.archive[o.archive.length-1].logoutTime&&0<o.archive.length){temp=o.archive[o.archive.length-1];let e=new Date;e.setMilliseconds(0),temp.logoutTime=e.toISOString(),temp.duration=Math.round(Math.round((e.getTime()-new Date(temp.loginTime).getTime())/1e3)/60),o.archive.splice(o.archive.length-1,1),o.archive.push(temp),chrome.runtime.sendMessage({storeSync:!0,data:{logins:o}})}},getLoginsArray:r,registerLogin:function(e){e={loginID:localStorage.userName,loggedOnUser:"true"==localStorage.googleAdminAccess&&"true"==localStorage.isManaged&&null!=localStorage.name?localStorage.name:localStorage.userName.split("@")[0],loginTime:new Date(parseInt(e)).toISOString(),uniqueSession:!0,logoutTime:null,duration:0,loginTitle:e},o.archive.push(e),chrome.runtime.sendMessage({storeSync:!0,data:{logins:o}})},loadArchivedLogins:function(r){return new Promise(function(n,e){chrome.runtime.sendMessage({getSync:!0,data:["logins"]},function(e){if(a=!0,e)for(t=e.logins,o.archive.splice(0,t.archive.length),i=0;i<t.archive.length;i++)null===t.archive[i].logoutTime&&(tempDate=new Date(parseInt(r)),t.archive[i].duration=Math.round((tempDate.getTime()-new Date(t.archive[i].loginTime).getTime())/6e4),t.archive[i].logoutTime=tempDate.toISOString()),o.archive.push(t.archive[i]);n()})})},clearLoginArchive:n,persistence:l}});