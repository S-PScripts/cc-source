define(["background/storageSync","modules/ciccore"],function(e,o){var a={archive:[]},l=!1;function n(){return new Promise(function(e,i){0!=Object.keys(a).length&&a.archive&&0<a.archive.length&&(null==a.archive[a.archive.length-1].logoutTime?a.archive.splice(0,a.archive.length-1):a.archive.splice(0,a.archive.length),chrome.runtime.sendMessage({storeSync:!0,data:{logins:a}}))})}function r(){if(a.archive&&0<a.archive.length){let e=a.archive[a.archive.length-1];return e.logoutTime||(e.duration=Math.round(((new Date).getTime()-new Date(e.loginTime).getTime())/6e4),a.archive.splice(a.archive.length-1,1),a.archive.push(e)),1==l&&1<a.archive.length&&(l=!1,a.archive.splice(0,1)),a}return{}}var c={save:function(){e.set({logins:r()})},load:function(){e.get(["logins","storedTimes","ids"]).then(function(t){new Promise(function(i,e){if(0<Object.keys(t).length){let e=t.logins;null!=e&&null!=e&&null!=e.archive&&null!=t.storedTimes&&null!=t.storedTimes.timestamp&&(e.archive.map(function(e){return null!=e.logoutTime&&null!=e.logoutTime||(e.logoutTime=o.core.dateToLocaleISOString(new Date(parseInt(t.storedTimes.timestamp)))),e}),i(e)),i(e)}}).then(function(i){require(["background/websocket"],function(e){e.sendLoginMeteringOnRestart(i).then(n).then(e.sendLoginsOnRestart())})})})}};return c.load(),{logins:a,registerLogout:function(){if(a.archive&&null!=a.archive[a.archive.length-1]&&null==a.archive[a.archive.length-1].logoutTime&&0<a.archive.length){temp=a.archive[a.archive.length-1];let e=new Date;e.setMilliseconds(0),temp.logoutTime=o.core.dateToLocaleISOString(e),temp.duration=Math.round(Math.round((e.getTime()-new Date(temp.loginTime).getTime())/1e3)/60),a.archive.splice(a.archive.length-1,1),a.archive.push(temp),chrome.runtime.sendMessage({storeSync:!0,data:{logins:a}})}},getLoginsArray:r,registerLogin:function(e){e={loginID:localStorage.userName,loggedOnUser:"true"==localStorage.googleAdminAccess&&"true"==localStorage.isManaged&&null!=localStorage.name?localStorage.name:localStorage.userName.split("@")[0],loginTime:o.core.dateToLocaleISOString(new Date(parseInt(e))),uniqueSession:!0,logoutTime:null,duration:0,loginTitle:e},a.archive.push(e),chrome.runtime.sendMessage({storeSync:!0,data:{logins:a}})},loadArchivedLogins:function(r){return new Promise(function(n,e){chrome.runtime.sendMessage({getSync:!0,data:["logins"]},function(e){if(l=!0,e)for(t=e.logins,a.archive.splice(0,t.archive.length),i=0;i<t.archive.length;i++)null===t.archive[i].logoutTime&&(tempDate=new Date(parseInt(r)),t.archive[i].duration=Math.round((tempDate.getTime()-new Date(t.archive[i].loginTime).getTime())/6e4),t.archive[i].logoutTime=o.core.dateToLocaleISOString(tempDate)),a.archive.push(t.archive[i]);n()})})},clearLoginArchive:n,persistence:c}});