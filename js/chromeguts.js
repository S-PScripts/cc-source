var Device,sharedKey,iv,debug=require(["logger"],function(e){debug=e.debug})["debug"],db=require(["logger"],function(e){db=e})["db"],NSLibrary=NSLibrary||{},API_Methods=this,windows=[];function NSLEvent(e){return{name:e,event:new Event(e)}}NSLibrary.Chrome=NSLibrary.Chrome||{},NSLibrary.events=NSLibrary.events||{ack:new NSLEvent("ack")};var sockets,gLatLng,updateStatusIconConnectionState,updateStatusViewShareInterval,surveyAnswered=!1,gApproved="",tmpSender="";NSLibrary.Client=NSLibrary.Client||{};var pinWebSocket,{View=null,UserAck=null}=NSLibrary.Client,gHeartBeat={event:null,action:null},productCode=20;localStorage.offlineLock=!1,localStorage.offlineMuteFlag=0,localStorage.offlineTimedOut=!1,localStorage.hangupCalled=!1,localStorage.hangupReceived=!1,localStorage.phraseMatchIDs=JSON.stringify([]),localStorage.persistentThumbnailTimer=void 0,localStorage.thumbnailTimer=void 0,localStorage.winID=null,localStorage.chatInstances=JSON.stringify({}),localStorage.connectedToTutor=!1,localStorage.shareScreenClosed=!0,localStorage.allowSendWebMetering=!1,localStorage.allowSendLoginMetering=!1,localStorage.activityMonitorChanged=!1;var i17n=new ArrayBuffer(32);new Uint32Array(i17n).set([2119247752,3830839039,2755063126,1614632788,1971797310,694919190,868398436,2758864662]);var $=window&&window.$||null;$&&$.getJSON("/oem.json",function(e){$.each(e,function(e,t){"product"===e&&(productCode=t)})});var tcpPage,tcpPageId,gThumbWidth,gThumbHeight,gWebflag,gRedirect,UTF8=NSLibrary.UTF8,tcpConnected=0;localStorage.approvedWebList="";var gPin,gUsedMacAddress,gUsedIPAddress,gIncludes=[],gExcludes=[];let z=String.fromCharCode(0),z2=z+z,z3=z2+z,z4=z2+z2;localStorage.z=z;var frameCount=0,storedFrameCount=0,frameMap=new Map;function gd(){return i17n}require(["modules/background/platform"],function(e){e.isChromeOS().then(function(e){require(["modules/launch","content/options"],function(e,t){e.startListeners(),t.setup()}),require(["modules/ciccore","modules/cicregistration","settings","background/storage","pubsub","comms.nc","lib/batch","student","device","chatlib","models/Tab","comms.commands","comms.websocket","models/useridentity","models/deviceinfo","models/register","modules/extension","modules/initialize","modules/image","disconnect","socket","background/events","on/lifecycle"],function(l,n,e,t,o,a,r,i,c,s,d,g,u,m,S,h,b,p,v,f,w,C){localStorage.setItem("configInputSubmitClicked",!1),localStorage.chomegutscalled=!0,l.core.tooltip(),l.core.rewards(),localStorage.hangupCalled=!1,localStorage.hangupReceived=!1,localStorage.isWatching=!1,localStorage.removeClassCodeUI=!1,localStorage.unlockTimeout=void 0,db.logs=[],b.bind(API_Methods),require(["modules/image"],function(e){e.canvas=void 0,db.altdebug("215 resetting canvas")}),localStorage.clientName||(db.altdebug("207 chrmguts calling  identity.refresh.user"),m.refresh.user().then(function(e){var t=e.indexOf("@"),n="";t&&(n=e.substring(0,t));localStorage.clientName=n.replace(/\s/g,"").substring(0,30).toUpperCase(),localStorage.userName=e}).catch(e=>{"no-identity"!=e&&console.trace(e)})),localStorage.setItem("useracknowledgeAccepted",!1),NSLibrary.settings=e,g.process.HANGUP=function(e){l.core.persistentScreenshots(),localStorage.removeClassCodeUI=!1,localStorage.joinClassInitiated=!1,localStorage.joiningClassInProgress=!1,localStorage.lastEnteredValidCode=void 0,localStorage.internetStatus=1,localStorage.isHangup=!0,chrome.runtime.sendMessage({lessonObj:!0}),"false"==localStorage.isStreamActive&&chrome.runtime.sendMessage({endScreenshare:!0});null!=NSLibrary.Client.webRTCTutorWindowed&&NSLibrary.Client.webRTCTutorWindowed.removeWebRTCTutorWindowed();null!=NSLibrary.Client.webRTCTutorFullScreen&&NSLibrary.Client.webRTCTutorFullScreen.removeWebRTCTutorFullScreen();localStorage.showWebRTCTutorFullscreen=!1,localStorage.showWebRTCTutorWindowed=!1,localStorage.setItem("useracknowledgeAccepted",!1),i.reconnectMode.active=0,1==u.instance.websocket.readyState?(clearTimeout(i.reconnectMode.expiryHandler),i.reconnectMode.expiryHandler=setTimeout(i.reconnectMode.clear,1e4)):chrome.runtime.sendMessage({storeLocal:!0,data:{connectionState:"disconnected"}});var t=e.indexOf("CONNECTION_ID="),n=e.indexOf("\n",t+14),o=e.substring(t+14,n);u.instance.HANGUP(o),i.ActiveConnection&&i.ActiveConnection.cidt===o&&(i.powerMode=null,window.setTimeout(c.power.switchMode,9e4));for(var a in i.Connections)if(i.Connections[a].cidt==o){delete i.Connections[a],db.altdebug("751 Connection "+a+" removed - chromeguts"),db.altdebug("752 Connections[] "+Object.keys(i.Connections).length+" chromeguts"),f.reset(!0,{code:1e3,message:"HANGUP Received",cid:a}),window.clearInterval(i.tickle[a]),delete i.tickle[a];break}},window.CSParams=i,o.subscribe("senddata",function(e){b.senddata(e.cid,e.message)}),o.subscribe("updateSM",function(e){return"splice"==e.value?(delete i.Connections[e.cid],db.altdebug("239 Connection "+e.cid+" removed - chromeguts"),void db.altdebug("240 Connections[] "+Object.keys(i.Connections).length+" chromeguts")):(i.Connections[e.cid].sm=e.value,void l.core.sendHelpRequest())}),chrome.runtime.onConnectExternal.addListener(function(e){void 0!==tcpPageId&&e.sender&&e.sender.id==tcpPageId&&e.onMessage.addListener(function(e){tcpConnected=1;var t=String.fromCharCode(0,0,0,0)+e.data;e.nc&&a.Process(t)})}),chrome.runtime.sendMessage({getAll:!0},function(e){for(var t=0;t<e.length;t++)if(-1!=e[t].name.indexOf("TCP Connect")){tcpPageId=e[t].id,chrome.management.launchApp(tcpPageId),(tcpPage=chrome.runtime.connect(tcpPageId)).postMessage({clientName:localStorage.clientName,macAddress:localStorage.macAddress,roomName:localStorage.room});break}}),chrome.runtime.sendMessage({storageOnChanged:!0}),chrome.runtime.onMessage.addListener(function(e,t,n){return 1==e.storageOnChangedResponse&&NSLibrary.settings.handleChange(e.data.changes,e.data.location),!0}),chrome.runtime.onMessage.addListener(function(e,t,n){return 1==e.storageOnChangeDeviceDetailsChangeResponse&&l.core.deviceDetailsChange(e.data.changes),!0}),chrome.runtime.onMessage.addListener(function(e,t,n){return 1==e.storageOnChangeTimezoneChangeResponse&&l.core.timezoneChange(e.data.changes),!0}),window.addEventListener("online",function(){localStorage.ignoreProgress=!1}),chrome.runtime.sendMessage({onStateChanged:!0},function(){l.core.idleStateChange()}),window.addEventListener("offline",function(){localStorage.freqSaveLogs&&65!=parseInt(localStorage.freqSaveLogs)?(i.Connections={},db.altdebug("326 conections reset - chromeguts")):db.altdebug("328 IGNORING conections reset - chromeguts"),db.altdebug("330 CSParams.Connections removed - chromeguts"),NSLibrary.Client.webRTCTutorFullScreen.removeWebRTCTutorFullScreen(),NSLibrary.Client.webRTCTutorWindowed.removeWebRTCTutorWindowed(),chrome.runtime.sendMessage({storeLocal:!0,data:{showWebRTCTutorFullscreen:!1}}),chrome.runtime.sendMessage({storeLocal:!0,data:{showWebRTCTutorWindowed:!1}}),navigator.keyboard.unlock(),localStorage.ignoreProgress=!0,chrome.runtime.sendMessage({getLocal:!0,data:"muteSound"},function(e){1==e.muteSound&&l.core.muteUnMuteSound(1)})}),setInterval(function(){l.core.getTimezone()},2e3);var I="";updateStatusIconConnectionState=setInterval(function(){chrome.runtime.sendMessage({getLocal:!0,data:"connectionState"},function(e){var t;"connected_TUTOR"!=e.connectionState?("18"!=localStorage.cloudState&&(t=n.cic.cloudstate(),localStorage.cloudState=t),chrome.runtime.sendMessage({storeLocal:!0,data:{cloudState:t}}),"21"==(I="21"==t?t:I)&&"21"!=t?(null!=localStorage.roomspec&&u.instance.STATUS(localStorage.roomspec,0),I=""):"18"==t&&l.core.badge.updateBadgeColour("disconnected")):l.core.badge.updateBadgeColour("connected_TUTOR")})},2e3),setInterval(function(){n.cic.esafetyTimeSettings()},2e3),setInterval(function(){n.cic.recalculateActivityMonitorSettings()},2e3),new Promise(function(e,t){v.setDisplaySize(screen.width,screen.height),e({width:screen.width,height:screen.height})}),Promise.all([e.get.managed(),m.refresh.device(),m.refresh.user(),S.retrieve.deviceAsset(),S.retrieve.location(),S.retrieve.hardware(),S.retrieve.deviceSerial(),S.retrieve.deviceHostname()]).then(function(e){var t=e[0],n=e[1],o=e[2],a=e[3],r=e[4],i=e[5],c=e[6],s=e[7];l.core.branding(),l.core.initiateBrowserActionStatus();var d=(localStorage.fullemail=o).indexOf("@"),e="";d&&(e=o.substring(0,d)),n?localStorage.macAddress=n.long:localStorage.macAddress&&"undefined"!=localStorage.macAddress||(localStorage.macAddress=o),(!localStorage.clientName||t&&t.resetClientName)&&d&&(localStorage.clientName=e.replace(/\s/g,"").substring(0,30).toUpperCase(),localStorage.userName=o),i?(localStorage.model=i.model,localStorage.manufacturer=i.manufacturer):(localStorage.model="",localStorage.manufacturer=""),localStorage.deviceAssetId=a?a.devAssetId:localStorage.clientName,localStorage.serialNumber=c?c.deviceSerialNumber:localStorage.clientName,localStorage.deviceHostname=s?s.devHostname:"",localStorage.location=r?r.annotatedLocation:"","true"==localStorage.shouldRegisterDevice?setTimeout(function(){NSLibrary.settings.loadManagedAccountAndSite().then(function(n){db.altdebug("487 chrmguts - IS MANAGED - PERFORM REGISTER and INITIALISE"),require(["modules/cicregistration","modules/initialize"],function(e,t){e.cic.register(!1,n.accountID,n.siteID,n.region,function(){t(),l.core.updateHardwareInventory(),l.core.updateSoftwareInventory()})})},function(){chrome.runtime.sendMessage({storageSync:!0},function(e){var t,n,o;null!=e.deviceIsRegistered&&0!=e.deviceIsRegistered||0!=e.IsManaged?(0==e.IsManaged&&1==e.deviceIsRegistered&&(db.altdebug("515 chrmguts - IsManaged: "+e.IsManaged),db.altdebug("516 calling getAcceptableUsagePolicyPreflight"),db.saveLogs(),localStorage.isManaged=!1,t=localStorage.deviceID,o=localStorage.accountID,e=localStorage.region,t=JSON.stringify({deviceID:t,accountID:o}),n=new XMLHttpRequest,o=e,new RegExp("^(https?:\\/\\/)?((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|((\\d{1,3}\\.){3}\\d{1,3}))(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*(\\?[;&a-z\\d%_.~+=-]*)?(\\#[-a-z\\d_]*)?$","i").test(o)?n.open("POST",e+"/api/Devices/getConfig"):"nsclassroomapi"==e?n.open("POST","https://nsclassroomapi.azurewebsites.net/api/Devices/getConfig"):n.open("POST","https://api-"+e+".classroom.cloud/api/Devices/getConfig"),n.setRequestHeader("Content-Type","application/json"),n.send(t),n.onreadystatechange=function(){this.readyState===n.DONE&&200===this.status?require(["modules/initialize"],function(e){e(),l.core.updateHardwareInventory(),l.core.updateSoftwareInventory()}):this.readyState===n.DONE&&404===this.status&&require(["modules/cicregistration","modules/initialize"],function(e,t){e.cic.register(!1,localStorage.accountID,localStorage.siteID,localStorage.region,function(){t(),l.core.updateHardwareInventory(),l.core.updateSoftwareInventory()})})}),db.saveLogs()):(localStorage.isManaged=!1,chrome.runtime.sendMessage({queryTabs:!0,tabData:{url:chrome.runtime.getURL("configInputStartup.html")}},function(e){0==e.length&&chrome.runtime.sendMessage({createWindow:!0,windowData:{url:"configInputStartup.html",focused:!0,type:"popup",width:500,height:355}},function(e){db.saveLogs(),localStorage.configDialogID=e.id})}))})})},2e3):(chrome.action.setTitle({title:Translate("NOT_CONNECTED")}),chrome.runtime.sendMessage({setIcon:!0,iconPath:{16:"images/CIC16Disconnected.png",32:"images/CIC16Disconnected.png",48:"images/CIC16Disconnected.png",128:"images/CIC16Disconnected.png"}}))}).catch(e=>{"no-identity"!=e&&console.trace(e)}),View&&(chrome.runtime.sendMessage({windowOnFocusChanged:!0}),chrome.runtime.onMessage.addListener(function(e,t,n){1==e.windowOnFocusChangedResponse&&(localStorage.changedURL=null,i.get.currentWindow().then(d.updateCurrentWebsite).then(e=>{console.info("focused:",e.id)}).catch(function(e){}))}),chrome.runtime.sendMessage({getWindowCurrent:!0},function(e){View.width=screen.availWidth,View.height=screen.height,View.gridSizeX=View.width,View.gridSizeY=32,View.canvas.width=View.gridSizeX,View.canvas.height=View.gridSizeY,View.nrX=Math.round(View.width/View.gridSizeX),View.nrY=Math.round(View.height/View.gridSizeY),View.pixelCount=View.gridSizeX*View.gridSizeY*4,i.ScreenDimensions.width=e.width-16,i.ScreenDimensions.height=e.height-101-5})),window.addEventListener("storage",t.handler),o.subscribe("windowResize",function(){i.get.currentWindow().then(a.SendWSlave).then(r.squash(r.token.windowResize,300)).then(function(e){e.getScreen()}).catch(function(e){})}),chrome.runtime.sendMessage({tabOnActivated:!0}),chrome.runtime.onMessage.addListener(function(e,t,n){1==e.tabOnActivatedResponse&&(e=e.data,function(){for(var e in i.Connections){e=i.Connections[e];e.thumbi&&(e.thumbs=e.thumbi)}}(),d.updateCurrentWebsite({id:e.windowId}))}),chrome.runtime.sendMessage({tabOnUpdated:!0}),chrome.runtime.onMessage.addListener(function(e,t,n){1==e.tabOnUpdatedResponse&&d.Update(e.data.tabid,e.data.changeinfo,e.data.tab)}),chrome.runtime.sendMessage({tabOnReplaced:!0}),chrome.runtime.onMessage.addListener(function(e,t,n){1==e.tabOnReplacedResponse&&d.replace(e.data.addedTabId,e.data.removedTabId)}),chrome.runtime.sendMessage({clearId:!0}),chrome.runtime.onMessage.addListener(function(e,t,n){1==e.clearIdResponse&&d.clearId(e.tabid)})})}).catch(function(){console.log("OS not compatible")})});